function rcube_webmail(){this.labels={},this.buttons={},this.buttons_sel={},this.gui_objects={},this.gui_containers={},this.commands={},this.command_handlers={},this.onloads=[],this.messages={},this.group2expand={},this.http_request_jobs={},this.menu_stack=[],this.menu_buttons={},this.entity_selectors=[],this.image_style={},this.uploads={},this.dblclick_time=500,this.message_time=5e3,this.preview_delay_select=400,this.preview_delay_click=60,this.identifier_expr=/[^0-9a-z_-]/gi,this.uploadTimeout=0,this.env={attachments:{},request_timeout:180,draft_autosave:0,comm_path:"./",recipients_separator:",",recipients_delimiter:", ",popup_width:1150,popup_width_small:900,thread_padding:"15px"},this.ref="rcmail";var ref=this;$.ajaxSetup({cache:!1,timeout:1e3*this.env.request_timeout,error:function(a,b,c){ref.http_error(a,b,c)},beforeSend:function(a){a.setRequestHeader("X-Roundcube-Request",ref.env.request_token)}}),$(window).on("beforeunload",function(){ref.unload=!0}),this.set_env=function(a,b){if(null==a||"object"!=typeof a||b)this.env[a]=b;else for(var c in a)this.env[c]=a[c]},this.add_label=function(a,b){"string"==typeof a?this.labels[a]=b:"object"==typeof a&&$.extend(this.labels,a)},this.register_button=function(a,b,c,d,e,f){var g={id:b,type:c};d&&(g.act=d),e&&(g.sel=e),f&&(g.over=f),this.buttons[a]||(this.buttons[a]=[]),this.buttons[a].push(g),this.loaded&&(this.init_button(a,g),this.set_button(a,this.commands[a]?"act":"pas"))},this.register_menu_button=function(a,b){if(this.menu_buttons[b])this.menu_buttons[b][0].push(a);else{var c=[];$("#"+b).find("a").each(function(){var a,b=$(this),d=b.attr("onclick");a=d&&String(d).match(/rcmail\.command\(\'([^']+)/)?RegExp.$1:function(){return b.is(".active")},c.push(a)}),c.length&&(this.menu_buttons[b]=[[a],c])}this.set_menu_buttons()},this.set_menu_buttons=function(){clearTimeout(this.menu_buttons_timeout),this.menu_buttons_timeout=setTimeout(function(){$.each(ref.menu_buttons,function(){var a=!0;$.each(this[1],function(){var b="function"==typeof this;if(b&&this()||!b&&ref.commands[this])return a=!1}),$(this[0]).add($(this[0]).parent(".dropbutton")).addClass(a?"disabled":"active").removeClass(a?"active":"disabled")})},50)},this.gui_object=function(a,b){this.gui_objects[a]=this.loaded?rcube_find_object(b):b},this.gui_container=function(a,b){this.gui_containers[a]=b},this.add_element=function(a,b){this.gui_containers[b]&&this.gui_containers[b].jquery&&this.gui_containers[b].append(a)},this.register_command=function(a,b,c){this.command_handlers[a]=b,c&&this.enable_command(a,!0)},this.add_onload=function(a){this.onloads.push(a)},this.init=function(){var n;this.task=this.env.task,this.env.blankpage||(this.env.blankpage="javascript:false;");for(n in this.gui_containers)this.gui_containers[n]=$("#"+this.gui_containers[n]);for(n in this.gui_objects)this.gui_objects[n]=rcube_find_object(this.gui_objects[n]);switch(this.init_buttons(),this.is_framed()&&parent.rcmail.unlock_frame(),this.enable_command("close","logout","mail","addressbook","settings","save-pref","compose","undo","about","switch-task","menu-open","menu-close","menu-save",!0),this.set_button(this.task,"sel"),this.env.permaurl&&this.enable_command("permaurl","extwin",!0),this.task){case"mail":if(this.enable_command("list","checkmail","add-contact","search","reset-search","collapse-folder","import-messages",!0),this.gui_objects.messagelist){this.msglist_setup(this.env.layout),this.env.widescreen_list_template=[{className:"threads",cells:["threads"]},{className:"subject",cells:["fromto","date","size","status","subject"]},{className:"flags",cells:["flag","attachment"]}],this.message_list=new rcube_list_widget(this.gui_objects.messagelist,{multiselect:!0,multiexpand:!0,draggable:!0,keyboard:!0,column_movable:this.env.col_movable,dblclick_time:this.dblclick_time}),this.message_list.addEventListener("initrow",function(a){ref.init_message_row(a)}).addEventListener("dblclick",function(a){ref.msglist_dbl_click(a)}).addEventListener("keypress",function(a){ref.msglist_keypress(a)}).addEventListener("select",function(a){ref.msglist_select(a)}).addEventListener("dragstart",function(a){ref.drag_start(a)}).addEventListener("dragmove",function(a){ref.drag_move(a)}).addEventListener("dragend",function(a){ref.drag_end(a)}).addEventListener("expandcollapse",function(a){ref.msglist_expand(a)}).addEventListener("column_replace",function(a){ref.msglist_set_coltypes(a)}).init(),$(this.message_list.thead).on("click","a.sortcol",function(a){return ref.command("sort",$(this).attr("rel"),this)}),this.enable_command("toggle_status","toggle_flag","sort",!0),this.enable_command("set-listmode",this.env.threads&&!this.is_multifolder_listing());var searchfilter=$(this.gui_objects.search_filter).val();searchfilter&&"ALL"!=searchfilter?this.filter_mailbox(searchfilter):this.command("list"),$(this.gui_objects.qsearchbox).val(this.env.search_text).focusin(function(){ref.message_list.blur()})}this.set_button_titles(),this.env.message_commands=["show","reply","reply-all","reply-list","move","copy","delete","open","mark","edit","viewsource","bounce","print","load-attachment","download-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment","change-format"],"show"==this.env.action||"preview"==this.env.action?(this.enable_command(this.env.message_commands,this.env.uid),this.enable_command("reply-list",this.env.list_post),"show"==this.env.action&&this.http_request("pagenav",{_uid:this.env.uid,_mbox:this.env.mailbox,_search:this.env.search_request},this.display_message("","loading")),this.env.mail_read_time>0&&setTimeout(function(){ref.http_post("mark",{_uid:ref.env.uid,_flag:"read",_mbox:ref.env.mailbox,_quiet:1})},1e3*this.env.mail_read_time),this.env.blockedobjects&&($(this.gui_objects.remoteobjectsmsg).show(),this.enable_command("load-remote",!0)),"preview"==this.env.action&&this.is_framed()&&(this.enable_command("compose","add-contact",!1),parent.rcmail.show_contentframe(!0)),$.inArray("flagged",this.env.message_flags)>=0&&$(document.body).addClass("status-flagged"),this.gui_objects.attachments&&$("li > a",this.gui_objects.attachments).not(".drop").on("dragstart",function(a){var b,c=this.href,d=a.originalEvent.dataTransfer;d&&(c=c.replace(/^https?:\/\//,function(a){return a+urlencode(ref.env.username)+"@"}),b=$(this).clone(),b.children().remove(),d.setData("roundcube-uri",c),d.setData("roundcube-name",b.text().trim()))}),this.check_mailvelope(this.env.action)):"compose"==this.env.action?(this.env.address_group_stack=[],this.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-addresses","pushgroup","search","reset-search","extwin","insert-response","menu-open","menu-close","load-attachment","download-attachment","open-attachment","rename-attachment"],this.env.drafts_mailbox&&this.env.compose_commands.push("savedraft"),this.enable_command(this.env.compose_commands,!0),$.merge(this.env.compose_commands,["add-recipient","firstpage","previouspage","nextpage","lastpage"]),window.googie&&(this.env.editor_config.spellchecker=googie,this.env.editor_config.spellcheck_observer=function(a){ref.spellcheck_state()},this.env.compose_commands.push("spellcheck"),this.enable_command("spellcheck",!0)),this.editor_init(null,this.env.composebody),this.init_messageform(),this.check_mailvelope(this.env.action)):"bounce"==this.env.action?(this.init_messageform_inputs(),this.env.compose_commands=[]):"get"==this.env.action?(this.enable_command("download",!0),this.enable_command("image-scale","image-rotate",!!/^image\//.test(this.env.mimetype)),this.enable_command("print","application/pdf"!=this.env.mimetype||!bw.mz||bw.vendver>=75),this.env.is_message&&(this.enable_command("reply","reply-all","edit","viewsource","forward","forward-inline","forward-attachment","bounce",!0),this.env.list_post&&this.enable_command("reply-list",!0)),this.env.mimetype.startsWith("image/")&&$(this.gui_objects.messagepartframe).on("load",function(){var a=$(this).contents();a.find("img").length&&(a.find("img").css({maxWidth:"100%",maxHeight:"100%"}),a.find("body").css({display:"flex",alignItems:"center",justifyContent:"center",height:"100%",margin:0}),a.find("html").css({height:"100%"}))})):"print"==this.env.action&&this.env.uid&&(this.check_mailvelope(this.env.action),this.env.is_pgp_content||this.env.pgp_mime_part||this.print_dialog()),this.gui_objects.mailboxlist&&(this.env.unread_counts={},this.gui_objects.folderlist=this.gui_objects.mailboxlist,this.http_request("getunread",{_page:this.env.current_page})),this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:!1,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){ref.triggerEvent("insertrow",{cid:a.uid,row:a})}).addEventListener("select",function(a){ref.compose_recipient_select(a)}).addEventListener("dblclick",function(a){ref.compose_add_recipient()}).addEventListener("keypress",function(a){a.key_pressed==a.ENTER_KEY&&(ref.compose_add_recipient()||a.last_selected&&"G"==String(a.last_selected).charAt(0)&&$(a.rows[a.last_selected].obj).find("a").first().click())}).init(),$("#_to,#_cc,#_bcc").focus(function(){ref.env.focused_field=this})),this.gui_objects.addressbookslist&&(this.gui_objects.folderlist=this.gui_objects.addressbookslist,this.enable_command("list-addresses",!0)),this.env.mdn_request&&this.env.uid&&this.mdn_request_dialog(this.env.uid,this.env.mailbox),this.is_framed()||this.env.extwin||this.browser_capabilities_check();break;case"addressbook":this.env.address_group_stack=[],this.gui_objects.folderlist&&(this.env.contactfolders=$.extend($.extend({},this.env.address_sources),this.env.contactgroups)),this.enable_command("add","import",this.env.writable_source),this.enable_command("list","listgroup","pushgroup","popgroup","listsearch","search","reset-search","advanced-search",!0),this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:!!this.gui_objects.folderlist,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){ref.triggerEvent("insertrow",{cid:a.uid,row:a})}).addEventListener("keypress",function(a){ref.list_keypress(a)}).addEventListener("select",function(a){ref.contactlist_select(a)}).addEventListener("dragstart",function(a){ref.drag_start(a)}).addEventListener("dragmove",function(a){ref.drag_move(a)}).addEventListener("dragend",function(a){ref.drag_end(a)}).init(),$(this.gui_objects.qsearchbox).focusin(function(){ref.contact_list.blur()}),this.update_group_commands(),this.command("list")),this.gui_objects.savedsearchlist&&(this.savedsearchlist=new rcube_treelist_widget(this.gui_objects.savedsearchlist,{id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode}),this.savedsearchlist.addEventListener("select",function(a){ref.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"})})),this.set_page_buttons(),this.env.cid&&(this.enable_command("show","edit","qrcode",!0),this.gui_objects.editform&&$("input.groupmember").change(function(){ref.group_member_change(this.checked?"add":"del",ref.env.cid,ref.env.source,this.value)})),this.gui_objects.editform?(this.enable_command("save",!0),"add"!=this.env.action&&"edit"!=this.env.action&&"search"!=this.env.action||this.init_contact_form()):"print"==this.env.action&&this.print_dialog();break;case"settings":this.enable_command("show","save",!0),"identities"==this.env.action?this.enable_command("add",this.env.identities_level<2):"edit-identity"==this.env.action||"add-identity"==this.env.action?(this.enable_command("save","edit",!0),this.enable_command("delete",this.env.identities_level<2),"edit-identity"==this.env.action&&this.check_mailvelope(this.env.action)):"folders"==this.env.action?this.enable_command("subscribe","unsubscribe","create-folder","rename-folder",!0):"edit-folder"==this.env.action&&this.gui_objects.editform?(this.enable_command("save","folder-size",!0),parent.rcmail.env.exists=this.env.messagecount,parent.rcmail.enable_command("purge",this.env.messagecount)):"responses"==this.env.action&&this.enable_command("add",!0),this.gui_objects.identitieslist?(this.identity_list=new rcube_list_widget(this.gui_objects.identitieslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.identity_list.addEventListener("select",function(a){ref.identity_select(a)}).addEventListener("keypress",function(a){ref.list_keypress(a)}).init().focus()):this.gui_objects.sectionslist?(this.sections_list=new rcube_list_widget(this.gui_objects.sectionslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.sections_list.addEventListener("select",function(a){ref.section_select(a)}).init().focus()):this.gui_objects.subscriptionlist?this.init_subscription_list():this.gui_objects.responseslist&&(this.responses_list=new rcube_list_widget(this.gui_objects.responseslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.responses_list.addEventListener("select",function(a){ref.response_select(a)}).addEventListener("keypress",function(a){ref.list_keypress(a)}).init().focus());break;case"login":var tz,tz_name,input_user=$("#rcmloginuser"),input_tz=$("#rcmlogintz");""==input_user.val()?input_user.focus():$("#rcmloginpwd").focus(),window.jstz&&(tz=jstz.determine())&&(tz_name=tz.name()),input_tz.val(tz_name||(new Date).getStdTimezoneOffset()/-60),$("form").submit(function(){$("[type=submit]",this).prop("disabled",!0),ref.clear_messages(),ref.display_message("","loading")})}this.gui_objects.editform&&$("input,select,textarea",this.gui_objects.editform).not(":hidden").not(":disabled").first().select().focus(),bw.ie&&$("input[type=file]").keydown(function(a){"13"==a.keyCode&&a.preventDefault()}),this.loaded=!0,this.env.lastrefresh=new Date,this.pending_message&&this.display_message.apply(this,this.pending_message),this.gui_objects.folderlist&&window.rcube_treelist_widget&&this.gui_objects.folderlist!=this.gui_objects.addressbookslist&&(this.treelist=new rcube_treelist_widget(this.gui_objects.folderlist,{selectable:!0,id_prefix:"rcmli",parent_focus:!0,id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,check_droptarget:function(a){return!a.virtual&&ref.check_droptarget(a.id)}}),this.treelist.addEventListener("collapse",function(a){ref.folder_collapsed(a)}).addEventListener("expand",function(a){ref.folder_collapsed(a)}).addEventListener("beforeselect",function(a){return!ref.busy}).addEventListener("select",function(a){ref.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"}),ref.mark_all_read_state()})),this.gui_objects.filedrop&&this.env.filedrop&&window.FormData&&($(document.body).on("dragover dragleave drop",function(a){return ref.document_drag_hover(a,"dragover"==a.type)}),$(this.gui_objects.filedrop).addClass("droptarget").on("dragover dragleave",function(a){return ref.file_drag_hover(a,"dragover"==a.type)}).get(0).addEventListener("drop",function(a){return ref.file_dropped(a)},!1));var body_mouseup=function(a){return ref.doc_mouse_up(a)};$(document.body).mouseup(body_mouseup).keydown(function(a){return ref.doc_keypress(a)}),rcube_webmail.set_iframe_events({mouseup:body_mouseup}),this.triggerEvent("init",{task:this.task,action:this.env.action});for(n in this.onloads)"string"==typeof this.onloads[n]?eval(this.onloads[n]):"function"==typeof this.onloads[n]&&this.onloads[n]();$("[data-popup]").each(function(){ref.register_menu_button(this,$(this).data("popup"))}),this.start_refresh(),this.start_keepalive()},this.log=function(a){this.env.devel_mode&&window.console&&console.log},this.command=function(a,b,c,d,e){var f;if(!c||!c.blur||d&&rcube_event.is_keyboard(d)||c.blur(),this.busy&&("reset-search"!=a||"search"!=this.last_command)&&!a.match(/^menu-/))return!1;if(c&&c.href&&String(c.href).indexOf("#")<0&&rcube_event.get_modifier(d))return!0;if(!e&&!this.commands[a])return this.is_framed()&&parent.rcmail.command(a,b),!1;if("mail"==this.task&&"compose"==this.env.action&&!this.env.server_error&&"save-pref"!=a&&($.inArray(a,this.env.compose_commands)<0||a.startsWith("compose-encrypted")&&ref.mailvelope_editor)&&!this.compose_skip_unsavedcheck&&!this.env.is_sent&&this.cmp_hash!=this.compose_field_hash())return this.confirm_dialog(this.get_label("notsentwarning"),"discard",function(){ref.remove_compose_data(ref.env.compose_id),ref.compose_skip_unsavedcheck=!0,ref.command(a,b,c,d)}),!1;if(this.last_command=a,this.command_aborted=!1,this.triggerEvent("actionbefore",{props:b,action:a,originalEvent:d}),void 0!==(f=this.triggerEvent("before"+a,b||d))){if(!1===f)return!1;b=f}return f="function"==typeof this.command_handlers[a]?this.command_handlers[a](b,c,d):"string"==typeof this.command_handlers[a]?window[this.command_handlers[a]](b,c,d):this.command_handler(a,b,c,d),this.command_aborted||!1!==this.triggerEvent("after"+a,b)||(f=!1),this.triggerEvent("actionafter",{props:b,action:a,aborted:this.command_aborted,ret:f,originalEvent:d}),!1!==f&&!(c&&!0!==f||!0===this.command_aborted)},this.command_handler=function(a,b,c,d){var e,f,g,h;switch(a){case"logout":case"mail":case"addressbook":case"settings":this.switch_task(a);break;case"about":this.redirect("?_task=settings&_action=about",!1);break;case"permaurl":if(c&&c.href&&c.target)return!0;this.env.permaurl&&(parent.location.href=this.env.permaurl);break;case"extwin":if("compose"==this.env.action){var i=this.gui_objects.messageform,j=this.open_window("");j&&(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0,$("[name='_action']",i).val("compose"),i.action=this.url("mail/compose",{_id:this.env.compose_id,_extwin:1}),i.target=j.name,i.submit())}else this.open_window(this.env.permaurl,!0);break;case"change-format":g=this.env.permaurl+"&_format="+b,"preview"==this.env.action&&(g=g.replace(/_action=show/,"_action=preview")+"&_framed=1"),this.env.extwin&&(g+="&_extwin=1"),location.href=g;break;case"menu-open":if(b&&"attachmentmenu"==b.menu){var k=this.env.attachments[b.id];k&&k.mimetype&&(k=k.mimetype),this.enable_command("open-attachment",k&&this.env.mimetypes&&$.inArray(k,this.env.mimetypes)>=0)}this.show_menu(b,b.show||void 0,d);break;case"menu-close":this.hide_menu(b,d);break;case"menu-save":return this.triggerEvent(a,{props:b,originalEvent:d}),!1;case"open":if(e=this.get_single_uid())return c.href=this.url("show",this.params_from_uid(e,{_extwin:1})),!0;break;case"close":this.env.extwin&&window.close();break;case"list":b&&""!=b&&this.reset_qsearch(!0),"compose"==this.env.action&&this.env.extwin?window.close():"mail"==this.task?(this.list_mailbox(b,b?1:""),this.set_button_titles()):"addressbook"==this.task&&this.list_contacts(b);break;case"set-listmode":this.set_list_options(null,void 0,void 0,"threads"==b?1:0);break;case"sort":var l=this.env.sort_order,m=this.env.disabled_sort_col?this.env.sort_col:b;this.env.disabled_sort_order||(l=this.env.sort_col==m&&"ASC"==l?"DESC":"ASC"),this.set_list_sorting(m,l),this.list_mailbox("","",m+"_"+l);break;case"nextpage":this.list_page("next");break;case"lastpage":this.list_page("last");break;case"previouspage":this.list_page("prev");break;case"firstpage":this.list_page("first");break;case"expunge":this.env.exists&&this.expunge_mailbox(this.env.mailbox);break;case"purge":case"empty-mailbox":this.env.exists&&this.purge_mailbox(this.env.mailbox);break;case"show":if("mail"==this.task){if((e=this.get_single_uid())&&(!this.env.uid||e!=this.env.uid)){var n=this.get_message_mailbox(e);n==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:e,_mbox:n}):this.show_message(e)}}else"addressbook"==this.task?!(f=b||this.get_single_cid())||"show"==this.env.action&&f==this.env.cid||this.load_contact(f,"show"):"settings"==this.task&&this.goto_url("settings/"+b,{_framed:0});break;case"add":"addressbook"==this.task?this.load_contact(0,"add"):"settings"==this.task&&"responses"==this.env.action?this.load_response(0,"add-response"):"settings"==this.task&&this.load_identity(0,"add-identity");break;case"edit":"addressbook"==this.task&&(f=this.get_single_cid())?this.load_contact(f,"edit"):"mail"==this.task&&(e=this.get_single_uid())&&(g={_mbox:this.get_message_mailbox(e)},g[g._mbox==this.env.drafts_mailbox&&"new"!=b?"_draft_uid":"_uid"]=e,this.open_compose_step(g));break;case"save":var o,i=this.gui_objects.editform;if(i){if((o=$("[name='_pagesize']",i))&&o.length&&isNaN(parseInt(o.val()))){this.alert_dialog(this.get_label("nopagesizewarning"),function(){o.focus()});break}if("reload"==b)i.action+="&_reload=1";else if("settings"==this.task&&this.env.identities_level%2==0&&(o=$("[name='_email']",i))&&o.length&&!rcube_check_email(o.val())){this.alert_dialog(this.get_label("noemailwarning"),function(){o.focus()});break}parent.rcmail&&parent.rcmail.env.source&&(i.action=this.add_url(i.action,"_orig_source",parent.rcmail.env.source)),i.submit()}break;case"delete":"mail"==this.task?this.delete_messages(d):"addressbook"==this.task?this.delete_contacts():"settings"==this.task&&"responses"==this.env.action?this.delete_response():"settings"==this.task&&this.delete_identity();break;case"move":case"moveto":"mail"==this.task?this.move_messages(b,d):"addressbook"==this.task&&this.move_contacts(b,d);break;case"copy":"mail"==this.task?this.copy_messages(b,d):"addressbook"==this.task&&this.copy_contacts(b,d);break;case"mark":b&&this.mark_message(b);break;case"toggle_status":case"toggle_flag":h="toggle_flag"==a?"flagged":"read",(e=b)&&("flagged"==h?this.message_list.rows[e].flagged&&(h="unflagged"):this.message_list.rows[e].deleted?h="undelete":this.message_list.rows[e].unread||(h="unread"),this.mark_message(h,e));break;case"add-contact":this.add_contact(b);break;case"load-remote":if(this.env.uid){if(b&&this.env.sender){this.add_contact(this.env.sender,!0,b);break}this.show_message(this.env.uid,!0,"preview"==this.env.action)}break;case"load-attachment":case"open-attachment":case"download-attachment":var p,k=this.env.attachments[b];return"compose"==this.env.action?(p={_file:b,_id:this.env.compose_id},k=k?k.mimetype:""):p={_mbox:this.env.mailbox,_uid:this.env.uid,_part:b},"download-attachment"!=a&&k&&this.env.mimetypes&&$.inArray(k,this.env.mimetypes)>=0&&this.open_window(this.url("get",$.extend({_frame:1,_framed:0},p)))?!0:(p._download=1,this.compose_skip_unsavedcheck=1,this.goto_url("get",p,!1,!0),this.compose_skip_unsavedcheck=0,!0);case"select-all":this.select_all_mode=!b,this.dummy_select=!0;var q=this["addressbook"==this.task?"contact_list":"message_list"];"invert"==b?q.invert_selection():q.select_all("page"==b?"":b),this.dummy_select=null;break;case"select-none":this.select_all_mode=!1,this["addressbook"==this.task?"contact_list":"message_list"].clear_selection();break;case"expand-all":this.env.autoexpand_threads=1,this.message_list.expand_all();break;case"expand-unread":this.env.autoexpand_threads=2,this.message_list.collapse_all(),this.expand_unread();break;case"collapse-all":this.env.autoexpand_threads=0,this.message_list.collapse_all();break;case"nextmessage":this.env.next_uid&&this.show_message(this.env.next_uid,!1,"preview"==this.env.action);break;case"lastmessage":this.env.last_uid&&this.show_message(this.env.last_uid);break;case"previousmessage":this.env.prev_uid&&this.show_message(this.env.prev_uid,!1,"preview"==this.env.action);break;case"firstmessage":this.env.first_uid&&this.show_message(this.env.first_uid);break;case"compose":if(g={},"mail"==this.task)g={_mbox:this.env.mailbox,_search:this.env.search_request},b&&(g._to=b);else if("addressbook"==this.task)if(b&&b.indexOf("@")>0)g._to=b;else{var r=[];if(b?r.push(b):this.contact_list&&(r=this.contact_list.get_selection()),r.length){this.http_post("mailto",{_cid:r.join(","),_source:this.env.source},!0);break}if(this.env.group&&this.env.pagecount){this.http_post("mailto",{_gid:this.env.group,_source:this.env.source},!0);break}}else b&&"string"==typeof b?g._to=b:b&&"object"==typeof b&&$.extend(g,b);this.open_compose_step(g);break;case"spellcheck":this.spellcheck_state()?this.editor.spellcheck_stop():this.editor.spellcheck_start();break;case"savedraft":if(clearTimeout(this.save_timer),this.env.draft_id&&this.cmp_hash==this.compose_field_hash()){this.auto_save_start();break}this.submit_messageform(!0);break;case"send":if(!b.nocheck&&!this.env.is_sent&&!this.check_compose_input(a))break;clearTimeout(this.save_timer),this.submit_messageform();break;case"send-attachment":clearTimeout(this.save_timer),(h=this.upload_file(b||this.gui_objects.uploadform,"upload"))||(!1!==h&&this.alert_dialog(this.get_label("selectimportfile")),aborted=!0);break;case"insert-sig":this.change_identity($("[name='_from']")[0],!0);break;case"list-addresses":this.list_contacts(b),this.enable_command("add-recipient",!1);break;case"add-recipient":this.compose_add_recipient(b);break;case"reply-all":case"reply-list":case"reply":(e=this.get_single_uid())&&(g={_reply_uid:e,_mbox:this.get_message_mailbox(e),_search:this.env.search_request},"reply-all"==a?g._all=!b&&1==this.env.reply_all_mode&&this.commands["reply-list"]?"list":"all":"reply-list"==a&&(g._all="list"),this.open_compose_step(g));break;case"forward-attachment":case"forward-inline":case"forward":var s=this.env.uid?[this.env.uid]:this.message_list?this.message_list.get_selection():[];s.length&&(g={_forward_uid:this.uids_to_list(s),_mbox:this.env.mailbox,_search:this.env.search_request},("forward-attachment"==a||!b&&this.env.forward_attachment||s.length>1)&&(g._attachment=1),this.open_compose_step(g));break;case"print":"addressbook"==this.task?(e=this.get_single_cid())&&(g="&_action=print&_cid="+e,this.env.source&&(g+="&_source="+urlencode(this.env.source)),this.open_window(this.env.comm_path+g,!0,!0)):"get"!=this.env.action||this.env.is_message?(e=this.get_single_uid())&&(g=this.url("print",this.params_from_uid(e,{_safe:this.env.safemode?1:0})),this.open_window(g,!0,!0)&&"show"!=this.env.action&&"get"!=this.env.action&&this.mark_message("read",e)):this.gui_objects.messagepartframe.contentWindow.print();break;case"viewsource":(e=this.get_single_uid())&&this.open_window(this.url("viewsource",this.params_from_uid(e)),!0,!0);break;case"download":"get"==this.env.action?location.href=this.secure_url(location.href.replace(/_frame=/,"_download=")):(e=this.get_single_uid())&&this.goto_url("viewsource",this.params_from_uid(e,{_save:1}),!1,!0);break;case"search":return this.qsearch(b);case"reset-search":var t=this.env.search_request||this.env.qsearch;this.reset_qsearch(!0),t&&"compose"==this.env.action?this.contact_list&&this.list_contacts_clear():t&&this.env.mailbox?this.list_mailbox(this.env.mailbox,1):t&&"addressbook"==this.task&&(this.env.source=this.env.last_source||"",this.env.group=this.env.last_group||"",this.list_contacts(this.env.source,this.env.group,1));break;case"pushgroup":var u={id:b.id,search_request:this.env.search_request,page:this.env.current_page,search:this.env.search_request&&this.gui_objects.qsearchbox?this.gui_objects.qsearchbox.value:null};this.env.address_group_stack.push(u),c&&d&&rcube_event.cancel(d);case"listgroup":this.reset_qsearch(),this.list_contacts(b.source,b.id,1,u);break;case"popgroup":if(this.env.address_group_stack.length){var v=this.env.address_group_stack.pop();this.reset_qsearch(),v.search_request?(v.search&&this.gui_objects.qsearchbox&&$(this.gui_objects.qsearchbox).val(v.search),this.env.search_request=v.search_request,this.list_contacts_remote(null,null,this.env.current_page=v.page)):this.list_contacts(b.source,this.env.address_group_stack[this.env.address_group_stack.length-1].id)}break;case"import-messages":var i=b||this.gui_objects.importform,w=this.set_busy(!0,"importwait");(h=this.upload_file(i,"import",w))||(this.set_busy(!1,null,w),!1!==h&&this.alert_dialog(this.get_label("selectimportfile")),this.command_aborted=!0);break;case"import":var x=$("<iframe>").attr("src",this.url("import",{_framed:1,_target:this.env.source})),y=function(a){var b=x[0].contentWindow,c=null;if(c=b.rcmail.gui_objects.importformmap?b.rcmail.gui_objects.importformmap:b.rcmail.gui_objects.importform){var d,e=b.$("#rcmimportfile")[0];if(e&&!e.value)return void b.rcmail.alert_dialog(b.rcmail.get_label("selectimportfile"));d=b.rcmail.set_busy(!0,"importwait"),$('[name="_unlock"]',c).val(d),c.submit(),b.rcmail.lock_form(c,!0),$(a.target).attr("disabled",!0).next().focus()}},z=function(a,b){$(this).remove(),"reload"==ref.import_state&&ref.command("list")};this.import_state=null,this.import_dialog=this.simple_dialog(x,"importcontacts",y,{close:z,button:"import",width:500,height:300});break;case"export":this.contact_list.rowcount>0&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_search:this.env.search_request},!1,!0);break;case"export-selected":this.contact_list.rowcount>0&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_cid:this.contact_list.get_selection().join(",")},!1,!0);break;case"upload-photo":this.upload_contact_photo(b||this.gui_objects.uploadform);break;case"delete-photo":this.replace_contact_photo("-del-");break;case"undo":this.http_request("undo","",this.display_message("","loading"));break;default:var A=a.replace(/-/g,"_");if(this[A]&&"function"==typeof this[A])return this[A](b,c,d)}},this.enable_command=function(){var a,b,c,d=Array.prototype.slice.call(arguments),e=d.pop();for(b=0;b<d.length;b++)if("string"==typeof(c=d[b]))this.commands[c]=e,this.set_button(c,e?"act":"pas"),this.triggerEvent("enable-command",{command:c,status:e});else for(a in c)d.push(c[a]);this.set_menu_buttons()},this.command_enabled=function(a){return this.commands[a]},this.set_busy=function(a,b,c){if(a&&b){var d=this.get_label(b);d==b&&(d="Loading..."),c=this.display_message(d,"loading")}else!a&&c&&this.hide_message(c);return this.busy=a,this.gui_objects.editform&&this.lock_form(this.gui_objects.editform,a),c},this.get_label=function(a,b){return b&&this.labels[b+"."+a]?this.labels[b+"."+a]:this.labels[a]?this.labels[a]:a},this.gettext=this.get_label,this.switch_task=function(a){var b,c;if(2==(c=a.split("/")).length&&(a=c[0],b=c[1]),this.task!==a||"mail"==a){var d=this.get_task_url(a);b&&(d+="&_action="+b),"mail"==a?d+="&_mbox=INBOX":"logout"==a&&(d=this.secure_url(d),this.clear_compose_data()),this.redirect(d)}},this.get_task_url=function(a,b){return b||(b=this.env.comm_path),b.match(/[?&]_task=[a-zA-Z0-9_-]+/)?b.replace(/_task=[a-zA-Z0-9_-]+/,"_task="+a):b.replace(/\?.*$/,"")+"?_task="+a},this.reload=function(a){this.is_framed()?parent.rcmail.reload(a):a?setTimeout(function(){ref.reload()},a):window.location&&(location.href=this.url("",{_extwin:this.env.extwin}))},this.add_url=function(a,b,c){var d,e,f="";return c=urlencode(c),/(#[a-z0-9_-]*)$/.test(a)&&(f=RegExp.$1,a=a.substr(0,a.length-f.length)),/(\?.*)$/.test(a)?(d=RegExp.$1,e=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)"),e.test(d)?d=d.replace(e,RegExp.$2+b+"="+c):d+="&"+b+"="+c,a.replace(/(\?.*)$/,d)+f):a+"?"+b+"="+c+f},this.secure_url=function(a){return this.add_url(a,"_token",this.env.request_token)},this.is_framed=function(){return this.env.framed&&parent.rcmail&&parent.rcmail!=this&&"function"==typeof parent.rcmail.command},this.save_pref=function(a){var b={_name:a.name,_value:a.value};a.session&&(b._session=a.session),a.env&&(this.env[a.env]=a.value),this.http_post("save-pref",b)},this.html_identifier=function(a,b){return b?this.html_identifier_encode(a):String(a).replace(this.identifier_expr,"_")},this.html_identifier_encode=function(a){return Base64.encode(String(a)).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")},this.html_identifier_decode=function(a){for(a=String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)},this.drag_menu=function(a,b){var c=rcube_event.get_modifier(a),d=this.gui_objects.dragmenu;if(d&&c==SHIFT_KEY&&this.commands.copy){var e=rcube_event.get_mouse_pos(a);return this.env.drag_target=b,this.show_menu(this.gui_objects.dragmenu.id,!0,a),$(d).css({top:e.y-10+"px",left:e.x-10+"px"}),!0}return!1},this.drag_menu_action=function(a){var b=this.gui_objects.dragmenu;b&&$(b).hide(),this.command(a,this.env.drag_target),this.env.drag_target=null},this.drag_start=function(a){this.drag_active=!0,this.preview_timer&&clearTimeout(this.preview_timer),this.treelist&&this.treelist.drag_start()},this.drag_end=function(a){var b,c;if(this.treelist&&this.treelist.drag_end(),(b=this.message_list)?c=this.env.mailboxes:(b=this.contact_list)&&(c=this.env.contactfolders),this.drag_active&&c&&this.env.last_folder_target&&!rcube_event.is_keyboard(a)){var d=c[this.env.last_folder_target];b.draglayer.hide(),this.contact_list?this.contacts_drag_menu(a,d)||this.command("move",d):this.drag_menu(a,d)||this.command("move",d)}this.drag_active=!1,this.env.last_folder_target=null},this.drag_move=function(a){if(this.gui_objects.folderlist){var b,c,d="draglayernormal",e=rcube_event.get_mouse_pos(a);this.contact_list&&this.contact_list.draglayer&&(c=this.contact_list.draglayer.attr("class")),this.treelist&&(b=this.treelist.intersects(e,!0))?(this.env.last_folder_target=b,d="draglayer"+(this.check_droptarget(b)>1?"copy":"normal")):this.env.last_folder_target=null,d!=c&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",d)}},this.collapse_folder=function(a){this.treelist&&this.treelist.toggle(a)},this.folder_collapsed=function(a){this.folder_collapsed_timer&&clearTimeout(this.folder_collapsed_timer);var b="addressbook"==this.env.task?"collapsed_abooks":"collapsed_folders",c=this.env[b],d="&"+urlencode(a.id)+"&";this.env[b]=c.replace(d,""),a.collapsed&&(this.env[b]=this.env[b]+d,!a.virtual&&this.env.mailbox&&this.env.mailbox.startsWith(a.id+this.env.delimiter)&&this.command("list",a.id)),this.drag_active||(c!==this.env[b]&&(this.folder_collapsed_timer=setTimeout(function(){ref.command("save-pref",{name:b,value:ref.env[b]})},10)),this.env.unread_counts&&this.set_unread_count_display(a.id,!1))},this.doc_mouse_up=function(a){var b,c=rcube_event.get_target(a);if(!$(c).closest(".ui-dialog, .ui-widget-overlay").length){if(window.rcube_list_widget&&rcube_list_widget._instances.length&&$.each(rcube_list_widget._instances,function(b,c){c&&!rcube_mouse_is_over(a,c.list.parentNode)&&c.blur()}),this.buttons_sel){for(b in this.buttons_sel)"function"!=typeof b&&this.button_out(this.buttons_sel[b],b);this.buttons_sel={}}setTimeout(function(a){var b,d,e,f,g=$(c).parents();for(f=ref.menu_stack.length-1;f>=0;f--)e=ref.menu_stack[f],b=$("#"+e),!b.is(":visible")||c==b.data("opener")||c==b.get(0)||g.is(b.data("opener"))||e==d||"true"==b.attr("data-editable")&&$(c).parents("#"+e).length||"true"==b.attr("data-sticky")&&rcube_mouse_is_over(a,b.get(0))||ref.hide_menu(e,a),d=b.data("parent")},10,a)}},this.doc_keypress=function(a){var b=function(a){var b,c,d=a<0?"prevAll":"nextAll",e=a<0?"last":"first";return ref.focused_menu&&(b=$("#"+ref.focused_menu))?(c=b.find(":focus").closest("li")[d]().has(":not([aria-disabled=true])").find("a,input")[e](),c.length||(c=b.find(":focus").closest("ul")[d]().has(":not([aria-disabled=true])").find("a,input")[e]()),c.focus().length):0},c=a.target||{},d=rcube_event.get_keycode(a);if(27!=a.keyCode&&(!this.menu_keyboard_active||"TEXTAREA"==c.nodeName||"SELECT"==c.nodeName))return!0;switch(d){case 38:case 40:case 63232:case 63233:return b(38==d||63232==d?-1:1),rcube_event.cancel(a);case 9:if(this.focused_menu){b(rcube_event.get_modifier(a)==SHIFT_KEY?-1:1)||this.hide_menu(this.focused_menu,a)}return rcube_event.cancel(a);case 27:this.menu_stack.length&&this.hide_menu(this.menu_stack[this.menu_stack.length-1],a)}return!0},this.list_keypress=function(a,b){a.modkey!=CONTROL_KEY&&(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY?this.command(b&&b.del?b.del:"delete"):33==a.key_pressed?this.command(b&&b.prev?b.prev:"previouspage"):34==a.key_pressed&&this.command(b&&b.next?b.next:"nextpage"))},this.msglist_keypress=function(a){a.key_pressed!=a.ENTER_KEY||this.env.contentframe?this.list_keypress(a):this.command("show")},this.msglist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b=!1,c=a.get_single_selection(),d=a.get_selection(!1),e=d.length;if(this.enable_command(this.env.message_commands,null!=c),e>0&&(this.env.multifolder_listing?$.each(d,function(a,c){if(ref.get_message_mailbox(c)==ref.env.drafts_mailbox)return b=!0,!1}):b=this.env.mailbox==this.env.drafts_mailbox),c)if(b)this.enable_command("reply","reply-all","reply-list","forward","forward-inline","forward-attachment","bounce",!1);else{var f=this.env.messages[c];f.ml||this.enable_command("reply-list",!1)}if(this.enable_command("delete","move","copy","mark",e>0),this.enable_command("forward","forward-attachment",!b&&e>0),(c||e&&e!=a.rowcount)&&(this.select_all_mode=!1),c&&this.env.contentframe&&!a.multi_selecting&&!this.dummy_select){var g=(new Date).getTime(),h=g-(this._last_msglist_select_time||0),i=this.preview_delay_click;h<this.preview_delay_select&&(i=this.preview_delay_select,this.preview_timer&&clearTimeout(this.preview_timer),this.env.contentframe&&this.show_contentframe(!1)),this._last_msglist_select_time=g,this.preview_timer=setTimeout(function(){ref.msglist_get_preview()},i)}else this.env.contentframe&&this.show_contentframe(!1)},this.msglist_dbl_click=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b,c=a.get_single_selection();c&&(b=this.get_message_mailbox(c),b==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:c,_mbox:b}):this.show_message(c))},this.msglist_get_preview=function(){var a=this.get_single_uid();a&&this.env.contentframe&&!this.drag_active?this.show_message(a,!1,!0):this.env.contentframe&&this.show_contentframe(!1)},this.msglist_expand=function(a){this.env.messages[a.uid]&&(this.env.messages[a.uid].expanded=a.expanded),$(a.obj)[a.expanded?"addClass":"removeClass"]("expanded")},this.msglist_set_coltypes=function(a){var b,c,d,e=a.thead.rows[0].cells;for(this.env.listcols=[],b=0;b<e.length;b++)e[b].id&&e[b].id.startsWith("rcm")&&(d=e[b].id.slice(3),this.env.listcols.push(d));this.msglist_setup(this.env.layout),(c=$.inArray("flag",this.env.listcols))>=0&&(this.env.flagged_col=c),(c=$.inArray("subject",this.env.listcols))>=0&&(this.env.subject_col=c),this.command("save-pref",{name:"list_cols",value:this.env.listcols,session:"list_attrib/columns"})},this.msglist_setup=function(a){var b,c;(b=this.triggerEvent("msglist_layout",a))&&(a=b),c=this.env["widescreen"==a?"listcols_widescreen":"listcols"],"widescreen"!=a||this.env.threading||(c=$.grep(c,function(a){return"threads"!=a})),this.env.msglist_layout=a,this.env.msglist_cols=c;var d=this.gui_objects.messagelist,e=d.className.split(" ").filter(function(a){return!a.startsWith("sort-")});e.push("sort-"+(this.env.sort_col||"none")),d.className=e.join(" ")},this.check_droptarget=function(a){switch(this.task){case"mail":return!this.env.mailboxes[a]||this.env.mailboxes[a].virtual||this.env.mailboxes[a].id==this.env.mailbox&&!this.is_multifolder_listing()?0:1;case"addressbook":var b;if(a!=this.env.source&&(b=this.env.contactfolders[a]))if("group"==b.type){if(b.id!=this.env.group&&!this.env.contactfolders[b.source].readonly){var c=this.env.selection_sources.length>1||-1==$.inArray(b.source,this.env.selection_sources);return!c||this.commands.move?1:2}}else if(!b.readonly&&(this.env.selection_sources.length>1||-1==$.inArray(a,this.env.selection_sources)))return this.commands.move?1:2}return 0},this.open_window=function(a,b,c){var d="rcmextwin"+(new Date).getTime();if(a+=(a.match(/\?/)?"&":"?")+"_extwin=1",this.env.standard_windows)var e=window.open(a,d);else var f=this.is_framed()?parent.window:window,g=$(f),h=g.width(),i=bw.mz?$("body",f).height():g.height(),j=Math.min(b?this.env.popup_width_small:this.env.popup_width,h),k=i,l=(f.screenLeft||f.screenX)+20,m=(f.screenTop||f.screenY)+20,e=window.open(a,d,"width="+j+",height="+k+",top="+m+",left="+l+",resizable=yes,location=no,scrollbars=yes"+(c?",toolbar=yes,menubar=yes,status=yes":",toolbar=no,menubar=no,status=no"));return!e||e.closed?void this.display_message("windowopenerror","warning"):(!a&&e.document&&e.document.write("<html><body>"+this.get_label("loading")+"</body></html>"),this.triggerEvent("openwindow",{url:a,handle:e}),setTimeout(function(){e&&e.focus()},10),e)},this.init_message_row=function(a){var b={},c=a.uid,d=(null!=this.env.status_col?"status":"msg")+"icn"+a.id;c&&this.env.messages[c]&&$.extend(a,this.env.messages[c]),(a.icon=document.getElementById(d))&&(b.icon=function(a){ref.command("toggle_status",c)}),null!=this.env.status_col?a.msgicon=document.getElementById("msgicn"+a.id):a.msgicon=a.icon,null!=this.env.flagged_col&&(a.flagicon=document.getElementById("flagicn"+a.id))&&(b.flagicon=function(a){ref.command("toggle_flag",c)}),!a.depth&&a.has_children&&(a.expando=document.getElementById("rcmexpando"+a.id))&&(b.expando=function(a){ref.expand_message_row(a,c)}),$.each(b,function(b,c){a[b].onclick=function(a){return c(a),rcube_event.cancel(a)},bw.touch&&a[b].addEventListener&&a[b].addEventListener("touchend",function(a){if(1==a.changedTouches.length)return c(a),rcube_event.cancel(a)},!1)}),this.triggerEvent("insertrow",{uid:c,row:a})},this.add_message_row=function(a,b,c,d){if(!this.gui_objects.messagelist||!this.message_list)return!1;if(c.mbox!=this.env.mailbox&&!c.skip_mbox_check)return!1;if(this.message_list.rows[a])return!1;this.env.messages[a]||(this.env.messages[a]={}),$.extend(this.env.messages[a],{deleted:c.deleted?1:0,replied:c.answered?1:0,unread:c.seen?0:1,forwarded:c.forwarded?1:0,flagged:c.flagged?1:0,has_children:c.has_children?1:0,depth:c.depth?c.depth:0,unread_children:c.unread_children||0,flagged_children:c.flagged_children||0,parent_uid:c.parent_uid||0,selected:this.select_all_mode||this.message_list.in_selection(a),ml:c.ml?1:0,ctype:c.ctype,mbox:c.mbox,flags:c.extra_flags});var e,f,g,h,i,j,k="",l="",m="",n="",o=this.message_list,p=o.rows,q=this.env.messages[a],r=this.html_identifier(a,!0),s="message"+(c.seen?"":" unread")+(c.deleted?" deleted":"")+(c.flagged?" flagged":"")+(q.selected?" selected":""),t={cols:[],style:{},id:"rcmrow"+r,uid:a},u=this.env.msglist_layout,v=this.env.msglist_cols;if("widescreen"==u?this.env.status_col=null:(f=$.inArray("status",v))>=0&&(this.env.status_col=f),i="msgicon",null===this.env.status_col&&(i+=" status",c.deleted?(k+=" deleted",l+=this.get_label("deleted")+" "):c.seen?c.unread_children>0&&(k+=" unreadchildren"):(k+=" unread",l+=this.get_label("unread")+" ")),c.answered&&(k+=" replied",l+=this.get_label("replied")+" "),c.forwarded&&(k+=" forwarded",l+=this.get_label("forwarded")+" "),q.selected&&!o.in_selection(a)&&o.selection.push(a),this.env.threading&&(q.depth?(m+='<span id="rcmtab'+r+'" class="branch" style="width:'+15*q.depth+'px;">&nbsp;&nbsp;</span>',p[q.parent_uid]&&!1===p[q.parent_uid].expanded||!(0!=this.env.autoexpand_threads&&2!=this.env.autoexpand_threads||p[q.parent_uid]&&p[q.parent_uid].expanded)?(t.style.display="none",q.expanded=!1):q.expanded=!0,s+=" thread expanded"):q.has_children&&(void 0===q.expanded&&(1==this.env.autoexpand_threads||2==this.env.autoexpand_threads&&q.unread_children)&&(q.expanded=!0),n='<div id="rcmexpando'+t.id+'" class="'+(q.expanded?"expanded":"collapsed")+'">&nbsp;&nbsp;</div>',s+=" thread"+(q.expanded?" expanded":"")),c.unread_children&&c.seen&&!q.expanded&&(s+=" unroot"),c.flagged_children&&!q.expanded&&(s+=" flaggedroot")),m+='<span id="msgicn'+t.id+'" class="'+i+k+'" title="'+l+'"></span>',t.className=s,b.subject){var w=c.mbox==this.env.drafts_mailbox?"compose":"show",x=c.mbox==this.env.drafts_mailbox?"_draft_uid":"_uid",y={_mbox:c.mbox};y[x]=a,b.subject='<a href="'+this.url(w,y)+'" onclick="return rcube_event.keyboard_only(event)" onmouseover="rcube_webmail.long_subject_title(this)" tabindex="-1"><span>'+b.subject+"</span></a>"}for(f in v)e=v[f],g={className:String(e).toLowerCase(),events:{}},this.env.coltypes[e]&&this.env.coltypes[e].hidden&&(g.className+=" hidden"),"flag"==e?(i=c.flagged?"flagged":"unflagged",j=this.get_label(i),h='<span id="flagicn'+t.id+'" class="'+i+'" title="'+j+'"></span>'):"attachment"==e?(j=this.get_label("withattachment"),h=c.attachmentClass?'<span class="'+c.attachmentClass+'" title="'+j+'"></span>':"multipart/report"==c.ctype?'<span class="report"></span>':"multipart/encrypted"==c.ctype||"application/pkcs7-mime"==c.ctype?'<span class="encrypted"></span>':c.hasattachment||!c.hasnoattachment&&/application\/|multipart\/(m|signed)/.test(c.ctype)?'<span class="attachment" title="'+j+'"></span>':"&nbsp;"):"status"==e?(j="",c.deleted?(i="deleted",j=this.get_label("deleted")):c.seen?i=c.unread_children>0?"unreadchildren":"msgicon":(i="unread",j=this.get_label("unread")),h='<span id="statusicn'+t.id+'" class="'+i+k+'" title="'+j+'"></span>'):"threads"==e?h=n:"subject"==e?h=m+b[e]:"priority"==e?c.prio>0&&c.prio<6?(j=this.get_label("priority")+" "+c.prio,h='<span class="prio'+c.prio+'" title="'+j+'"></span>'):h="&nbsp;":h="folder"==e?'<span onmouseover="rcube_webmail.long_subject_title(this)">'+b[e]+"<span>":b[e],g.innerHTML=h,t.cols.push(g);if("widescreen"==u&&(t=this.widescreen_message_row(t,a,q)),o.insert_row(t,d),d&&this.env.pagesize&&o.rowcount>this.env.pagesize){var a=o.get_last_row();o.remove_row(a),o.clear_selection(a)}},this.widescreen_message_row=function(a,b,c){var d=document.createElement("tr");return d.id=a.id,d.uid=a.uid,d.className=a.className,a.style&&$.extend(d.style,a.style),$.each(this.env.widescreen_list_template,function(){if(ref.env.threading||"threads"!=this.className){var b,c,e,f,g=document.createElement("td");for(this.className&&(g.className=this.className),b=0;this.cells&&b<this.cells.length;b++)for(c=0;a.cols&&c<a.cols.length;c++)if(this.cells[b]==a.cols[c].className){e=a.cols[c],f=document.createElement("span"),f.className=this.cells[b],"subject"==this.className&&"subject"!=f.className&&(f.className+=" skip-on-drag"),e.innerHTML&&(f.innerHTML=e.innerHTML),g.appendChild(f);break}d.appendChild(g)}}),this.env.threading&&c.depth&&(n=this.calculate_thread_padding(c.depth),$("td.subject",d).attr("style","padding-left:"+n+" !important"),$("span.branch",d).remove()),d},this.calculate_thread_padding=function(a){return ref.env.thread_padding.match(/^([0-9.]+)(.+)/),Math.min(6,a)*parseFloat(RegExp.$1)+RegExp.$2},this.set_list_sorting=function(a,b){var c="arrival"==this.env.sort_col?"date":this.env.sort_col,d="arrival"==a?"date":a;$("#rcm"+c).removeClass("sorted"+this.env.sort_order.toUpperCase()),d&&$("#rcm"+d).addClass("sorted"+b),$("#rcmdate > a").prop("rel","arrival"==a?"arrival":"date"),this.env.sort_col=a,this.env.sort_order=b},this.set_list_options=function(a,b,c,d,e){var f,g={};if(void 0===b&&(b=this.env.sort_col),c||(c=this.env.sort_order),this.env.sort_col==b&&this.env.sort_order==c||(f=1,this.set_list_sorting(b,c)),this.env.threading!=d&&(f=1,g._threads=d),e&&this.env.layout!=e&&(this.triggerEvent("layout-change",{old_layout:this.env.layout,new_layout:e}),f=1,this.env.layout=g._layout=e,this.msglist_setup(this.env.layout)),a&&a.length){var h,i,j,k=[],l=this.env.listcols;for(h=0;h<l.length;h++)j=l[h],-1!=(i=$.inArray(j,a))&&(k.push(j),delete a[i]);for(h=0;h<a.length;h++)a[h]&&k.push(a[h]);k.join()!=l.join()&&(f=1,g._cols=k.join(","))}f&&this.list_mailbox("","",b+"_"+c,g)},this.show_message=function(a,b,c){if(a){var d,e=window,f=this.params_from_uid(a,{_caps:this.browser_capabilities()});c&&(d=this.get_frame_window(this.env.contentframe))&&(e=d,f._framed=1),b&&(f._safe=1),this.env.search_request&&(f._search=this.env.search_request),this.env.extwin&&(f._extwin=1),f=this.url(c?"preview":"show",f),c&&(this.preview_id=a),c&&String(e.location.href).indexOf(f)>=0?this.show_contentframe(!0):c||!this.env.message_extwin||this.env.extwin?(b&&document.referrer&&window.history.replaceState&&window.history.replaceState({},"",document.referrer),this.location_href(f,e,!0)):this.open_window(f,!0)}},this.set_unread_message=function(a,b){var c=this;c.message_list||(c=c.opener()),!c&&window.parent&&(c=parent.rcmail),c&&c.message_list&&(!1===c.set_message(a,"unread",!1)&&c.set_message(a+"-"+b,"unread",!1),c.env.unread_counts[b]>0&&(c.env.unread_counts[b]-=1,c.set_unread_count(b,c.env.unread_counts[b],"INBOX"==b&&!c.is_multifolder_listing())))},this.show_contentframe=function(a){var b,c,d=this.env.contentframe;(b=this.get_frame_element(d))&&(!a&&(c=this.get_frame_window(d))?c.location.href.indexOf(this.env.blankpage)<0&&(c.stop?c.stop():c.document.execCommand("Stop"),c.location.href=this.env.blankpage):bw.safari||bw.konq||$(b)[a?"show":"hide"]()),a||(this.unlock_frame(),delete this.preview_id)},this.get_frame_element=function(a){var b;if(a&&(b=document.getElementById(a)))return b},this.get_frame_window=function(a){var b=this.get_frame_element(a);if(b&&b.name&&window.frames)return window.frames[b.name]},this.lock_frame=function(a){var b=this.is_framed()?parent.rcmail:this;b.env.frame_lock||(b.env.frame_lock=b.set_busy(!0,"loading"));try{a.frameElement&&$(a.frameElement).on("load.lock",function(a){b.unlock_frame(),$(this).off("load.lock")})}catch(a){}},this.unlock_frame=function(){this.env.frame_lock&&(this.set_busy(!1,null,this.env.frame_lock),this.env.frame_lock=null)},this.list_page=function(a){"next"==a?a=this.env.current_page+1:"last"==a?a=this.env.pagecount:"prev"==a&&this.env.current_page>1?a=this.env.current_page-1:"first"==a&&this.env.current_page>1&&(a=1),a>0&&a<=this.env.pagecount&&(this.env.current_page=a,"addressbook"==this.task||this.contact_list?this.list_contacts(this.env.source,this.env.group,a):"mail"==this.task&&this.list_mailbox(this.env.mailbox,a))},this.checkmail=function(){var a=this.set_busy(!0,"checkingmail"),b=this.check_recent_params();this.http_post("check-recent",b,a)},this.filter_mailbox=function(a){if(!this.filter_disabled){var b=this.search_params(!1,a),c=this.set_busy(!0,"searching");this.clear_message_list(),this.env.current_page=1,this.env.search_filter=a,this.http_request("search",b,c),this.update_state({_mbox:b._mbox,_filter:a,_scope:b._scope})}},this.refresh_list=function(){this.list_mailbox(this.env.mailbox,this.env.current_page||1,null,{_clear:1},!0),this.message_list&&this.message_list.clear_selection()},this.list_mailbox=function(a,b,c,d,e){var f,g=window;if("object"!=typeof d&&(d={}),a||(a=this.env.mailbox?this.env.mailbox:"INBOX"),c&&(d._sort=c),this.env.mailbox!=a?(b=1,this.env.current_page=b,this.env.search_scope="base",this.select_all_mode=!1,this.reset_search_filter()):this.env.search_request&&(d._search=this.env.search_request),e||(this.clear_message_list(),a==this.env.mailbox&&(a!=this.env.mailbox||b||c)||(d._refresh=1),this.select_folder(a,"",!0),this.unmark_folder(a,"recent","",!0),this.env.mailbox=a),this.gui_objects.messagelist)return void this.list_mailbox_remote(a,b,d);(f=this.get_frame_window(this.env.contentframe))&&(g=f,d._framed=1),this.env.uid&&(d._uid=this.env.uid),b&&(d._page=b),a&&(d._mbox=a,this.set_busy(!0,"loading"),this.location_href(d,g))},this.clear_message_list=function(){this.env.messages={},this.show_contentframe(!1),this.message_list&&this.message_list.clear(!0)},this.list_mailbox_remote=function(a,b,c){var d=this.set_busy(!0,"loading");"object"!=typeof c&&(c={}),c._layout=this.env.layout,c._mbox=a,c._page=b,this.http_request("list",c,d),this.update_state({_mbox:a,_page:b&&b>1?b:null})},this.update_selection=function(){var a,b=this.message_list,c=b.selection,d=b.rows,e=[];for(a in c)d[c[a]]&&e.push(c[a]);b.selection=e;try{var f=this.get_frame_window(this.env.contentframe),g=f.rcmail.env.uid;g&&!b.in_selection(g)&&this.show_contentframe(!1)}catch(a){}},this.expand_unread=function(){for(var a,b=this.message_list.tbody,c=b.firstChild;c;)1==c.nodeType&&(a=this.message_list.rows[c.uid])&&a.unread_children&&(this.message_list.expand_all(a),this.set_unread_children(a.uid)),c=c.nextSibling;return!1},this.expand_message_row=function(a,b){var c=this.message_list.rows[b];c.expanded=!c.expanded,this.set_unread_children(b),this.set_flagged_children(b),c.expanded=!c.expanded,this.message_list.expand_row(a,b)},this.expand_threads=function(){if(this.env.threading&&this.env.autoexpand_threads&&this.message_list)switch(this.env.autoexpand_threads){case 2:this.expand_unread();break;case 1:this.message_list.expand_all()}},this.init_threads=function(a,b){if(b&&b!=this.env.mailbox)return!1;for(var c=0,d=a.length;c<d;c++)this.add_tree_icons(a[c]);this.expand_threads()},this.add_tree_icons=function(a){var b,c,d,e,f,g=[],h=[],i=this.message_list.rows;for(f=a?i[a]?i[a].obj:null:this.message_list.tbody.firstChild;f;){if(1==f.nodeType&&(c=i[f.uid]))if(c.depth){for(b=g.length-1;b>=0&&(d=g[b].length,d>c.depth?(e=d-c.depth,2&g[b][e]||(g[b][e]=g[b][e]?g[b][e]+2:2)):d==c.depth&&(2&g[b][0]||(g[b][0]+=2)),!(c.depth>d));b--);g.push(new Array(c.depth)),g[g.length-1][0]=1,h.push(c.uid)}else{if(g.length){for(b in g)this.set_tree_icons(h[b],g[b]);g=[],h=[]}if(a&&f!=i[a].obj)break}f=f.nextSibling}if(g.length)for(b in g)this.set_tree_icons(h[b],g[b])},this.set_tree_icons=function(a,b){var c,d=[],e="",f=b.length;for(c=0;c<f;c++)b[c]>2?d.push({class:"l3",width:15}):b[c]>1?d.push({class:"l2",width:15}):b[c]>0?d.push({class:"l1",width:15}):d.length&&!d[d.length-1].class?d[d.length-1].width+=15:d.push({class:null,width:15});for(c=d.length-1;c>=0;c--)d[c].class?e+='<div class="tree '+d[c].class+'" />':e+='<div style="width:'+d[c].width+'px" />';e&&$("#rcmtab"+this.html_identifier(a,!0)).html(e)},this.update_thread_root=function(a,b){if(this.env.threading){var c=this.message_list.find_root(a);if(a!=c){var d=this.message_list.rows[c];if("read"==b&&d.unread_children)d.unread_children--;else if("unread"==b&&d.has_children)d.unread_children=(d.unread_children||0)+1;else if("unflagged"==b&&d.flagged_children)d.flagged_children--;else{if("flagged"!=b||!d.has_children)return;d.flagged_children=(d.flagged_children||0)+1}this.set_message_icon(c),this.set_unread_children(c),this.set_flagged_children(c)}}},this.update_thread=function(a){if(!this.env.threading||!this.message_list.rows[a])return 0;var b,c,d=0,e=this.message_list,f=e.rows,g=f[a],h=f[a].depth,i=[];for(g.depth||d--,g.depth&&g.unread&&(c=e.find_root(a),f[c].unread_children--,this.set_unread_children(c)),g.depth&&g.flagged&&(c=e.find_root(a),f[c].flagged_children--,this.set_flagged_children(c)),c=g.parent_uid,g=g.obj.nextSibling;g;){if(1==g.nodeType&&(b=f[g.uid])){if(!b.depth||b.depth<=h)break;b.depth--,$("#rcmtab"+b.id).width(15*b.depth).html(""),b.depth?(b.depth==h&&(b.parent_uid=c),b.unread&&i.length&&i[i.length-1].unread_children++):(d++,b.parent_uid=0,b.has_children&&($("#"+b.id+" .leaf").first().attr("id","rcmexpando"+b.id).attr("class","none"!=b.obj.style.display?"expanded":"collapsed").mousedown({uid:b.uid},function(a){return ref.expand_message_row(a,a.data.uid)}),b.unread_children=0,i.push(b)),"none"==b.obj.style.display&&$(b.obj).show())}g=g.nextSibling}for(b=0;b<i.length;b++)this.set_unread_children(i[b].uid),this.set_flagged_children(i[b].uid);return d},this.delete_excessive_thread_rows=function(){for(var a=this.message_list.rows,b=this.message_list.tbody,c=b.firstChild,d=this.env.pagesize+1;c;)1==c.nodeType&&(r=a[c.uid])&&(!r.depth&&d&&d--,d||this.message_list.remove_row(c.uid)),c=c.nextSibling},this.set_message_icon=function(a){var b,c="",d=this.message_list.rows[a];if(!d)return!1;d.icon&&(b="msgicon",d.deleted?(b+=" deleted",c+=this.get_label("deleted")+" "):d.unread?(b+=" unread",c+=this.get_label("unread")+" "):d.unread_children&&(b+=" unreadchildren"),d.msgicon==d.icon&&(d.replied&&(b+=" replied",c+=this.get_label("replied")+" "),d.forwarded&&(b+=" forwarded",c+=this.get_label("forwarded")+" "),b+=" status"),$(d.icon).attr({class:b,title:c})),d.msgicon&&d.msgicon!=d.icon&&(c="",b="msgicon",!d.unread&&d.unread_children&&(b+=" unreadchildren"),d.replied&&(b+=" replied",c+=this.get_label("replied")+" "),d.forwarded&&(b+=" forwarded",c+=this.get_label("forwarded")+" "),$(d.msgicon).attr({class:b,title:c})),d.flagicon&&(b=d.flagged?"flagged":"unflagged",c=this.get_label(b),$(d.flagicon).attr("class",b).attr({"aria-label":c,title:c}))},this.set_message_status=function(a,b,c){var d=this.message_list.rows[a];if(!d)return!1;"unread"==b?d.unread!=c&&this.update_thread_root(a,c?"unread":"read"):"flagged"==b&&this.update_thread_root(a,c?"flagged":"unflagged"),$.inArray(b,["unread","deleted","replied","forwarded","flagged"])>-1&&(d[b]=c)},this.set_message=function(a,b,c){var d=this.message_list&&this.message_list.rows[a];if(!d)return!1;b&&this.set_message_status(a,b,c),$.inArray(b,["unread","deleted","flagged"])>-1&&$(d.obj)[d[b]?"addClass":"removeClass"](b),this.set_unread_children(a),this.set_message_icon(a)},this.set_unread_children=function(a){var b=this.message_list.rows[a];if(!b.parent_uid){var c=!b.unread&&b.unread_children&&!b.expanded;$(b.obj)[c?"addClass":"removeClass"]("unroot")}},this.set_flagged_children=function(a){var b=this.message_list.rows[a];if(!b.parent_uid){var c=b.flagged_children&&!b.expanded;$(b.obj)[c?"addClass":"removeClass"]("flaggedroot")}},this.copy_messages=function(a,b,c){if(a&&"object"==typeof a)a.uids&&(c=a.uids),a=a.id;else if(!a)return c=this.env.uid?[this.env.uid]:this.message_list.get_selection(),this.folder_selector(b,function(a,d){ref.command("copy",{id:a,uids:c},d,b,!0)});if(a&&a!=this.env.mailbox){var d=this.selection_post_data({_target_mbox:a,_uid:c});d._uid&&this.http_post("copy",d,this.display_message("copyingmessage","loading"))}},this.move_messages=function(a,b,c){if(a&&"object"==typeof a)a.uids&&(c=a.uids),a=a.id;else if(!a)return c=this.env.uid?[this.env.uid]:this.message_list.get_selection(),this.folder_selector(b,function(a,d){ref.command("move",{id:a,uids:c},d,b,!0)});if(a&&(a!=this.env.mailbox||this.is_multifolder_listing())){var d=!1,e=this.selection_post_data({_target_mbox:a,_uid:c});e._uid&&("show"==this.env.action&&(d=this.set_busy(!0,"movingmessage")),this.enable_command(this.env.message_commands,!1),this.with_selected_messages("move",e,d),"show"!=this.env.action&&this.show_contentframe(!1))}},this.delete_messages=function(a){var b=this.message_list,c=this.env.trash_mailbox;return this.env.flag_for_deletion?(this.mark_message("delete"),!1):(c&&this.env.mailbox!=c?this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox?this.permanently_remove_messages():b&&b.modkey==SHIFT_KEY||a&&rcube_event.get_modifier(a)==SHIFT_KEY?this.confirm_dialog(this.get_label("deletemessagesconfirm"),"delete",function(){ref.permanently_remove_messages()}):this.move_messages(c):this.permanently_remove_messages(),!0)},this.permanently_remove_messages=function(){var a=this.selection_post_data();a._uid&&(this.with_selected_messages("delete",a),this.show_contentframe(!1))},this.with_selected_messages=function(a,b,c,d){var e,f=0,g="delete"==a||!this.is_multifolder_listing();if(this.message_list){var h,i,j,k,l=[],m=b._uid,n=this.check_display_next();for("*"===m?m=this.message_list.get_selection():"string"==typeof m&&(m=m.split(",")),h=0,i=m.length;h<i;h++)j=m[h],this.env.threading&&(f+=this.update_thread(j),(k=this.message_list.find_root(j))!=j&&$.inArray(k,l)<0&&l.push(k)),g&&this.message_list.remove_row(j,n&&h==m.length-1);for(!n&&g&&this.message_list.clear_selection(),h=0,i=l.length;h<i;h++)this.add_tree_icons(l[h])}f<0?b._count=-1*f:f>0&&g&&this.delete_excessive_thread_rows(),g||(b._refresh=1),c||(e="move"==a?"movingmessage":"deletingmessage",c=this.display_message(e,"loading")),this.http_post(d||a,b,c)},this.selection_post_data=function(a){return"object"!=typeof a&&(a={}),a._uid||(a._uid=this.env.uid?[this.env.uid]:this.message_list.get_selection()),a._mbox=this.env.mailbox,a._uid=this.uids_to_list(a._uid),this.env.action&&(a._from=this.env.action),this.env.search_request&&(a._search=this.env.search_request),this.env.display_next&&this.env.next_uid&&(a._next_uid=this.env.next_uid),a},this.check_display_next=function(){return this.env.display_next&&(this.preview_id||!this.env.contentframe)},this.mark_message=function(a,b){var c,d,e,f=[],g=[],h=this.message_list;if(b?f.push(b):this.env.uid?f.push(this.env.uid):h&&(f=h.get_selection()),h)for(h.focus(),d=0,c=f.length;d<c;d++)e=f[d],("read"==a&&h.rows[e].unread||"unread"==a&&!h.rows[e].unread||"delete"==a&&!h.rows[e].deleted||"undelete"==a&&h.rows[e].deleted||"flagged"==a&&!h.rows[e].flagged||"unflagged"==a&&h.rows[e].flagged)&&g.push(e);else g=f;if(g.length||this.select_all_mode)switch(a){case"read":case"unread":this.toggle_read_status(a,g);break;case"delete":case"undelete":this.toggle_delete_status(g);break;case"flagged":case"unflagged":this.toggle_flagged_status(a,f)}},this.toggle_read_status=function(a,b){var c,d=b.length,e=this.selection_post_data({_uid:b,_flag:a}),f=this.display_message("markingmessage","loading");for(c=0;c<d;c++)this.set_message(b[c],"unread","unread"==a);this.http_post("mark",e,f)},this.toggle_flagged_status=function(a,b){var c,d=b.length,e=this.env.contentframe?this.get_frame_window(this.env.contentframe):window,f=this.selection_post_data({_uid:b,_flag:a}),g=this.display_message("markingmessage","loading");for(c=0;c<d;c++)this.set_message(b[c],"flagged","flagged"==a);("show"==this.env.action||$.inArray(this.preview_id,b)>=0)&&$(e.document.body)["flagged"==a?"addClass":"removeClass"]("status-flagged"),this.http_post("mark",f,g)},this.toggle_delete_status=function(a){var b,c,d=!0,e=a.length,f=this.message_list?this.message_list.rows:{};if(1==e)return!this.message_list||f[a[0]]&&!f[a[0]].deleted?this.flag_as_deleted(a):this.flag_as_undeleted(a),!0;for(b=0;b<e;b++)if(c=a[b],f[c]&&!f[c].deleted){d=!1;break}return d?this.flag_as_undeleted(a):this.flag_as_deleted(a),!0},this.flag_as_undeleted=function(a){var b,c=a.length,d=this.selection_post_data({_uid:a,_flag:"undelete"}),e=this.display_message("markingmessage","loading");for(b=0;b<c;b++)this.set_message(a[b],"deleted",!1);this.http_post("mark",d,e)},this.flag_as_deleted=function(a){for(var b=[],c=this.selection_post_data({_uid:a,_flag:"delete"}),d=this.display_message("markingmessage","loading"),e=this.message_list,f=e?e.rows:{},g=0,h=this.check_display_next(),i=0,j=a.length;i<j;i++)uid=a[i],f[uid]&&(f[uid].unread&&(b[b.length]=uid),this.env.skip_deleted?(g+=this.update_thread(uid),e.remove_row(uid,h&&i==e.get_selection(!1).length-1)):this.set_message(uid,"deleted",!0));this.env.skip_deleted&&e&&(h&&e.rowcount||e.clear_selection(),g<0?c._count=-1*g:g>0&&this.delete_excessive_thread_rows()),b.length&&(c._ruid=this.uids_to_list(b)),this.env.skip_deleted&&this.env.display_next&&this.env.next_uid&&(c._next_uid=this.env.next_uid),this.http_post("mark",c,d)},this.flag_deleted_as_read=function(a){var b,c,d,e=this.message_list?this.message_list.rows:{};for("string"==typeof a&&(a=a.split(",")),c=0,d=a.length;c<d;c++)b=a[c],e[b]&&this.set_message(b,"unread",!1)},this.uids_to_list=function(a){return this.select_all_mode?"*":(!$.isArray(a)||1!=a.length&&-1!=String(a[0]).indexOf("-")||(a=a.join(",")),a)},this.set_button_titles=function(){var a="deletemessage";this.env.flag_for_deletion||!this.env.trash_mailbox||this.env.mailbox==this.env.trash_mailbox||this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox||(a="movemessagetotrash"),this.set_alttext("delete",a)},this.init_pagejumper=function(a){$(a).addClass("rcpagejumper").on("focus",function(b){var c,d="";for(c=1;c<=ref.env.pagecount;c++)d+="<li>"+c+"</li>";d='<ul class="toolbarmenu menu">'+d+"</ul>",ref.pagejump||(ref.pagejump=$('<div id="pagejump-selector" class="popupmenu"></div>').appendTo(document.body).on("click","li",function(){ref.busy||$(a).val($(this).text()).change()})),ref.pagejump.data("count")!=c&&ref.pagejump.html(d),ref.pagejump.attr("rel","#"+this.id).data("count",c),ref.show_menu("pagejump-selector",!0,b)}).on("keydown keyup click",function(b){var c,d=$("#pagejump-selector"),e=$("ul",d),f=$("li",e),g=(e.height(),parseInt(this.value));if(27!=b.which&&9!=b.which&&13!=b.which&&!d.is(":visible"))return ref.show_menu("pagejump-selector",!0,b);if("keydown"==b.type)if(40==b.which)f.length>g&&(this.value=g+=1);else if(38==b.which)g>1&&f.length>g-1&&(this.value=g-=1);else{if(13==b.which)return $(this).change();if(27==b.which||9==b.which)return ref.hide_menu("pagejump-selector",b),$(a).val(ref.env.current_page)}$("li.selected",e).removeClass("selected"),(c=$(f[g-1])).length&&(c.addClass("selected"),$("#pagejump-selector").scrollTop(e.height()/f.length*(g-1)-d.height()/2))}).on("change",function(a){var b=parseInt(this.value);b&&b!=ref.env.current_page&&!ref.busy&&(ref.hide_menu("pagejump-selector",a),ref.list_page(b))})},this.update_pagejumper=function(){$("input.rcpagejumper").val(this.env.current_page).prop("disabled",this.env.pagecount<2)},this.check_mailvelope=function(a){window.mailvelope?this.mailvelope_load(a):$(window).on("mailvelope",function(){ref.mailvelope_load(a)})},this.mailvelope_load=function(a){var b=this.env.mailvelope_main_keyring?void 0:this.env.user_id,c=function(b){ref.mailvelope_keyring=b,ref.mailvelope_init(a,b)};mailvelope.getVersion().then(function(a){return mailvelope.VERSION=a,mailvelope.VERSION_MAJOR=Math.floor(parseFloat(a)),mailvelope.getKeyring(b)}).then(c,function(a){b&&mailvelope.createKeyring(b).then(c,function(a){})})},this.mailvelope_init=function(a,b){if(window.mailvelope)if("show"==a||"preview"==a||"print"==a){if(this.env.is_pgp_content){var c=$(this.env.is_pgp_content).text();ref.mailvelope_display_container(this.env.is_pgp_content,c,b)}else if(this.env.pgp_mime_part){var d=this.display_message("loadingdata","loading"),e=this.env.pgp_mime_container;$.ajax({type:"GET",url:this.url("get",{_mbox:this.env.mailbox,_uid:this.env.uid,_part:this.env.pgp_mime_part}),error:function(a,b,c){ref.http_error(a,b,c,d)},success:function(a){ref.mailvelope_display_container(e,a,b,d)}})}}else if("compose"==a){this.env.compose_commands.push("compose-encrypted");var f=mailvelope.VERSION_MAJOR>=2,g=$('[name="_is_html"]').val()>0;if(f&&this.env.compose_commands.push("compose-encrypted-signed"),this.env.pgp_mime_message){var h=this.set_busy(!0,this.get_label("loadingdata"));$.ajax({type:"GET",url:this.url("get",this.env.pgp_mime_message),error:function(a,b,c){ref.http_error(a,b,c,h),ref.enable_command("compose-encrypted",!g),f&&ref.enable_command("compose-encrypted-signed",!g)},success:function(a){ref.set_busy(!1,null,h),g&&(ref.command("toggle-editor",{html:!1,noconvert:!0}),$("#"+ref.env.composebody).val("")),ref.compose_encrypted({quotedMail:a}),ref.enable_command("compose-encrypted",!0),ref.enable_command("compose-encrypted-signed",!1)}})}else this.enable_command("compose-encrypted",!g),f&&this.enable_command("compose-encrypted-signed",!g);this.addEventListener("actionafter",function(a){a.ret&&"toggle-editor"==a.action&&(ref.enable_command("compose-encrypted",!a.props.html),f&&ref.enable_command("compose-encrypted-signed",!a.props.html))})}else"edit-identity"==a&&ref.mailvelope_identity_keygen()},this.compose_encrypted_signed=function(a){a=a||{},a.signMsg=!0,this.compose_encrypted(a)},this.compose_encrypted=function(a){var b,c=$("#"+this.env.composebody).parent();ref.mailvelope_editor?(ref.mailvelope_editor=null,ref.set_button("compose-encrypted","act"),c.removeClass("mailvelope").find("iframe:not([aria-hidden=true])").remove(),$("#"+ref.env.composebody).show(),$("[name='_pgpmime']").remove(),ref.enable_command("toggle-editor","insert-response",!0),ref.enable_command("spellcheck",!!window.googie),ref.enable_command("insert-sig",!!(ref.env.signatures&&ref.env.identity&&ref.env.signatures[ref.env.identity])),ref.triggerEvent("compose-encrypted",{active:!1})):(this.spellcheck_state()&&this.editor.spellcheck_stop(),b=a.quotedMail?{quotedMail:a.quotedMail,quotedMailIndent:!1}:{predefinedText:$("#"+this.env.composebody).val()},a.signMsg&&(b.signMsg=a.signMsg),"reply"==this.env.compose_mode&&(b.quotedMailIndent=!0,b.quotedMailHeader=this.env.compose_reply_header),mailvelope.createEditorContainer("#"+c.attr("id"),ref.mailvelope_keyring,b).then(function(a){ref.mailvelope_editor=a,ref.set_button("compose-encrypted","sel"),c.addClass("mailvelope"),$("#"+ref.env.composebody).hide(),ref.enable_command("spellcheck","insert-sig","toggle-editor","insert-response",!1),ref.triggerEvent("compose-encrypted",{active:!0}),$.isEmptyObject(ref.env.attachments)||("draft"==ref.env.compose_mode&&1==Object.keys(ref.env.attachments).length&&"encrypted.asc"==ref.env.attachments[Object.keys(ref.env.attachments)[0]].name||ref.alert_dialog(ref.get_label("encryptnoattachments")),$.each(ref.env.attachments,function(a,b){ref.remove_from_attachment_list(a)}))},function(a){}))},this.mailvelope_submit_messageform=function(a,b){var c=[];$.each(["to","cc","bcc"],function(a,b){for(var d,e=$('[name="_'+b+'"]').val().trim();e.length&&rcube_check_email(e,!0);)d=RegExp.$2.replace(/^<+/,"").replace(/>+$/,""),c.push(d),e=e.substr(e.indexOf(d)+d.length+1).replace(/^\s*,\s*/,"")});var d=c.length>0;return ref.mailvelope_keyring.validKeyForAddress(c).then(function(e){var f=[];if($.each(e,function(a,b){!1===b&&(d=!1,f.push(a))}),!d&&f.length)return ref.simple_dialog(ref.get_label("nopubkeyfor").replace("$email",f.join(", "))+"<p>"+ref.get_label("searchpubkeyservers")+"</p>","encryptedsendialog",function(){ref.mailvelope_search_pubkeys(f,function(){return!0})},{button:"search"}),!1;if(!d)return c.length||ref.alert_dialog(ref.get_label("norecipientwarning"),function(){$("[name='_to']").focus()}),!1;var g=[],h=ref.env.identities[$("[name='_from'] option:selected").val()];$.each(ref.env.identities,function(a,b){g.push(b.email)}),ref.mailvelope_keyring.validKeyForAddress(g).then(function(d){if(valid_sender=null,$.each(d,function(a,b){if(!1!==b&&(valid_sender=a,valid_sender==h))return!1}),!valid_sender&&!confirm(ref.get_label("nopubkeyforsender")))return!1;c.push(valid_sender),ref.mailvelope_editor.encrypt(c).then(function(c){var d=ref.gui_objects.messageform,e=$("[name='_pgpmime']",d),f=ref.set_busy(!0,a||b?"savingmessage":"sendingmessage");d.target=ref.get_save_target(f),d._draft.value=a?"1":"",d.action=ref.add_url(d.action,"_unlock",f),d.action=ref.add_url(d.action,"_framed",1),b&&(d.action=ref.add_url(d.action,"_saveonly",1)),e.length||(e=$('<input type="hidden" name="_pgpmime">').appendTo(d)),e.val(c),d.submit()},function(a){})},function(a){})},function(a){}),!1},this.mailvelope_display_container=function(a,b,c,d){var e=function(b){$(a+" > iframe").remove(),ref.hide_message(d),ref.display_message(b.message,"error")};mailvelope.createDisplayContainer(a,b,c,{senderAddress:this.env.sender}).then(function(b){if(b.error&&b.error.message)return e(b.error);ref.hide_message(d),$(a).children().not("iframe").hide(),$(ref.gui_objects.messagebody).addClass("mailvelope"),ref.env.pgp_mime_part&&$("#attach"+ref.env.pgp_mime_part).remove(),setTimeout(function(){$(window).resize()},10)},e)},this.mailvelope_search_pubkeys=function(a,b,c){var d=[],e=new PublicKey(this.env.keyservers),f=ref.display_message("","loading");$.each(a,function(a,b){var c=$.Deferred();e.search(b,function(a,d){null!==d?c.resolve([b]):c.resolve([b].concat(a))}),d.push(c)}),$.when.apply($,d).then(function(){var a=[],d=[];$.each(arguments,function(b,c){var e=c.shift();c.length?d=d.concat(c):a.push(e)}),ref.hide_message(f),b(!0),d.length&&ref.mailvelope_key_import_dialog(d,c),a.length&&ref.display_message(ref.get_label("nopubkeyfor").replace("$email",a.join(", ")),"warning")}).fail(function(){ref.hide_message(f),ref.display_message("pubkeysearcherror","error"),b(!1)})},this.mailvelope_key_import_dialog=function(a,b){var c=$("<div>").addClass("listing pgpkeyimport");$.each(a,function(a,b){var d=$("<div>").addClass("key");b.revoked&&d.addClass("revoked"),b.disabled&&d.addClass("disabled"),b.expired&&d.addClass("expired"),d.append($("<label>").addClass("keyid").text(ref.get_label("keyid"))),d.append($("<a>").text(b.keyid.substr(-8).toUpperCase()).attr({href:b.info,target:"_blank",tabindex:"-1"})),d.append($("<label>").addClass("keylen").text(ref.get_label("keylength"))),d.append($("<span>").text(b.keylen)),b.expirationdate&&(d.append($("<label>").addClass("keyexpired").text(ref.get_label("keyexpired"))),d.append($("<span>").text(new Date(1e3*b.expirationdate).toDateString()))),b.revoked&&d.append($("<span>").addClass("keyrevoked").text(ref.get_label("keyrevoked")));var e=$("<ul>").addClass("uids");$.each(b.uids,function(a,b){var c=$("<li>").addClass("uid");b.revoked&&c.addClass("revoked"),b.disabled&&c.addClass("disabled"),b.expired&&c.addClass("expired"),e.append(c.text(b.uid))}),d.append(e),d.append($("<button>").attr("rel",b.keyid).text(ref.get_label("import")).addClass("button import importkey").prop("disabled",b.revoked||b.disabled||b.expired)),c.append(d)}),ref.simple_dialog($("<div>").append($("<p>").html(ref.get_label("encryptpubkeysfound"))).append(c),"importpubkeys",null,{cancel_label:"close",cancel_button:"close"}),c.on("click","button.importkey",function(){var a=$(this),c=a.attr("rel"),d=new PublicKey(ref.env.keyservers),e=ref.display_message("","loading");d.get(c,function(d,f){return ref.hide_message(e),f?void ref.display_message("keyservererror","error"):b?void b(d):void ref.mailvelope_keyring.importPublicKey(d).then(function(b){if("REJECTED"===b);else{var d=c.substr(-8).toUpperCase();a.closest(".key").fadeOut(),ref.display_message(ref.get_label("keyimportsuccess").replace("$key",d),"confirmation")}},function(a){})})})},this.mailvelope_identity_keygen=function(){var a=$(this.gui_objects.editform).find(".identity-encryption").first(),b=$(this.gui_objects.editform).find(".ff_email").val().trim();if(a.length&&b&&this.mailvelope_keyring.createKeyGenContainer){this.mailvelope_keyring.validKeyForAddress([b]).then(function(a){var c=[];if(a&&a[b]&&Array.isArray(a[b].keys)){for(var d=[],e=0;e<a[b].keys.length;e++)d.push(function(a){return ref.mailvelope_keyring.hasPrivateKey(a.fingerprint).then(function(b){b&&c.push(a)})}(a[b].keys[e]));return Promise.all(d).then(function(){return c})}return c}).then(function(c){var d=a.find(".identity-encryption-block").empty();if(c&&c.length){$("<p>").text(ref.get_label("encryptionprivkeysinmailvelope").replace("$nr",c.length)).appendTo(d);var e=$("<ul>").addClass("keylist").appendTo(d);$.each(c,function(a,c){$("<li>").appendTo(e).append($("<strong>").addClass("fingerprint").text(String(c.fingerprint).toUpperCase())).append($("<span>").addClass("identity").text("<"+b+"> "))})}else $("<p>").text(ref.get_label("encryptionnoprivkeysinmailvelope")).appendTo(d);$("<button>").attr("type","button").addClass("button create").text(ref.get_label("encryptioncreatekey")).appendTo(d).on("click",function(){ref.mailvelope_show_keygen_container(d,b)}),$("<span>").addClass("space").html("&nbsp;").appendTo(d),$("<button>").attr("type","button").addClass("button settings").text(ref.get_label("openmailvelopesettings")).appendTo(d).on("click",function(){ref.mailvelope_keyring.openSettings()}),a.show(),ref.triggerEvent("identity-encryption-show",{container:a})}).catch(function(a){})}},this.mailvelope_show_keygen_container=function(a,b){var c=(new Date).getTime(),d={email:b,fullName:$(ref.gui_objects.editform).find(".ff_name").val().trim()},e={userIds:[d],keySize:this.env.mailvelope_keysize};$("<div>").attr("id","mailvelope-keygen-container-"+c).css({height:"245px",marginBottom:"10px"}).appendTo(a.empty()),this.mailvelope_keyring.createKeyGenContainer("#mailvelope-keygen-container-"+c,e).then(function(c){if(c instanceof Error)throw c;$("<button>").attr("type","button").addClass("button mainaction generate").text(ref.get_label("generate")).appendTo(a).on("click",function(){var a=$(this).prop("disabled",!0);c.generate().then(function(a){"string"==typeof a&&a.indexOf("BEGIN PGP")>0&&(ref.display_message(ref.get_label("keypaircreatesuccess").replace("$identity",b),"confirmation"),ref.mailvelope_identity_keygen())}).catch(function(b){ref.display_message(b.message||"errortitle","error"),a.prop("disabled",!1)})}),$("<span>").addClass("space").html("&nbsp;").appendTo(a),$("<button>").attr("type","button").addClass("button cancel").text(ref.get_label("cancel")).appendTo(a).on("click",function(){ref.mailvelope_identity_keygen()}),ref.triggerEvent("identity-encryption-update",{container:a})}).catch(function(a){ref.display_message("errortitle","error"),ref.mailvelope_identity_keygen()})},this.mdn_request_dialog=function(a,b){var c={action:"mark",data:{_uid:a,_mbox:b,_flag:"mdnsent"}},d=[{text:this.get_label("send"),class:"mainaction send",click:function(a,b,d){c.action="sendmdn",(ref.is_framed()?parent.$:$)(d||this).dialog("close")}},{text:this.get_label("ignore"),class:"cancel",click:function(a,b,c){(ref.is_framed()?parent.$:$)(c||this).dialog("close")}}],e=function(a,b){ref.http_post(c.action,c.data),$(this).remove()};this.env.mdn_request_save&&d.unshift({text:this.get_label("sendalwaysto").replace("$email",this.env.mdn_request_sender.mailto),class:"mainaction send",click:function(a,b,d){c.data._save=ref.env.mdn_request_save,c.data._address=ref.env.mdn_request_sender.string,$(a.target).next().click()}}),this.show_popup_dialog(this.get_label("mdnrequest"),this.get_label("sendreceipt"),d,{close:e})},this.expunge_mailbox=function(a){var b,c={_mbox:a};a==this.env.mailbox&&(b=this.set_busy(!0,"loading"),c._reload=1,this.env.search_request&&(c._search=this.env.search_request)),this.http_post("expunge",c,b)},this.purge_mailbox=function(a){return this.confirm_dialog(this.get_label("purgefolderconfirm"),"delete",function(){var b,c={_mbox:a};a==ref.env.mailbox&&(b=ref.set_busy(!0,"loading"),c._reload=1),ref.http_post("purge",c,b)}),!1},this.mark_all_read=function(a,b){var c,d,e=[],f=this.message_list,g=a||this.env.mailbox,h={_uid:"*",_flag:"read",_mbox:g,_folders:b};if("string"!=typeof b){if(!(c=this.mark_all_read_state(g)))return;if(c>1)return $.each({cur:1,sub:2,all:4},function(a,b){var d="readallmode"+a,f=$("<label>").attr("for",d).text(ref.get_label("folders-"+a)),g=$("<input>").attr({type:"radio",value:a,name:"mode",id:d,disabled:!(c&b)});e.push($("<li>").append([g,f]))}),d=$('<ul class="proplist">').append(e),$("input:not([disabled])",d).first().attr("checked",!0),void this.simple_dialog(d,"markallread",function(){return ref.mark_all_read(g,$("input:checked",d).val()),!0},{button:"mark",button_class:"save"});h._folders="cur"}$.each(f?f.rows:[],function(a,c){if(c.unread){var d=ref.env.messages[a].mbox;("all"==b||d==ref.env.mailbox||"sub"==b&&d.startsWith(ref.env.mailbox+ref.env.delimiter))&&ref.set_message(a,"unread",!1)}}),this.http_post("mark",h,this.display_message("markingmessage","loading"))},this.mark_all_read_state=function(a){var b=0,c=this.treelist.get_item(a||this.env.mailbox),d=$(c).is(".unread")?1:0,e=$("li.unread",c).length,f=$("li.unread",ref.gui_objects.folderlist).length;return b+=d,b+=e?2:0,b+=f>d+e?4:0,this.enable_command("mark-all-read",b>0),b},this.bounce=function(a,b,c){var d=this.get_single_uid(),e=this.url("bounce",{_framed:1,_uid:d,_mbox:this.get_message_mailbox(d)}),f=$("<iframe>").attr("src",e),g=function(){var a=$("iframe",f)[0].contentWindow.rcmail;return{rc:a,form:a.gui_objects.messageform}},h=function(){var a={},b=g();$.each($(b.form).serializeArray(),function(){a[this.name]=this.value}),a._uid=b.rc.env.uid,a._mbox=b.rc.env.mailbox,delete a._action,delete a._task,(a._to||a._cc||a._bcc)&&(ref.http_post("bounce",a,ref.set_busy(!0,"sendingmessage")),f.dialog("close"))},i=function(){var a=g();return"object"==typeof a.form&&(!!a.rc.check_compose_address_fields(h,a.form)&&h())};return this.hide_menu("forwardmenu",c),f=this.simple_dialog(f,"bouncemsg",i,{button:"bounce",width:400,height:300}),!0},this.open_compose_step=function(a){var b=this.url("mail/compose",a);this.env.compose_extwin&&!this.env.extwin?this.open_window(b):(this.redirect(b),this.env.extwin&&window.resizeTo(Math.max(this.env.popup_width,$(window).width()),$(window).height()+24))},this.init_messageform=function(){if(!this.gui_objects.messageform)return!1;var a,b,c=$("[name='_from']"),d=$("[name='_to']"),e=$("[name='_subject']"),f=$("[name='_message']").get(0),g="1"==$("[name='_is_html']").val(),h=this.opener();h&&"compose"==h.env.action&&(setTimeout(function(){opener.history.length>1?opener.history.back():h.redirect(h.get_task_url("mail"))},100),this.env.opened_extwin=!0),g||(f.value&&void 0!==f.defaultValue&&(f.value=f.defaultValue),b=this.env.top_posting&&this.env.compose_mode?0:f.value.length,"select-one"==c.prop("type")&&(this.set_caret_pos(f,0),this.change_identity(c[0])),this.set_caret_pos(f,b),b&&$(f).scrollTop(f.scrollHeight)),this.env.save_localstorage&&this.compose_restore_dialog(0,g),""==d.val()?a=d:""==e.val()?a=e:f&&(a=f),this.env.compose_focus_elem=this.init_messageform_inputs(a),this.compose_field_hash(!0),this.auto_save_start()},this.init_messageform_inputs=function(a){var b,c=$("[name='_to']"),d=["cc","bcc","replyto","followupto"];this.init_address_input_events(c);for(b in d)this.init_address_input_events($("[name='_"+d[b]+"']"));return a||(a=c),$(a).focus().get(0)},this.compose_restore_dialog=function(a,b){var c,d,e,f=this.local_storage_get_item("compose.index",[]),g=function(a){++a<f.length&&ref.compose_restore_dialog(a,b)};for(c=a||0;c<f.length;c++)if(d=f[c],e=this.local_storage_get_item("compose."+d,null,!0)){if(e.changed&&d==this.env.compose_id){this.restore_compose_form(d,b);break}if((!this.env.draft_id||!e.draft_id||e.draft_id==this.env.draft_id)&&(!this.env.reply_msgid||e.reply_msgid==this.env.reply_msgid)&&e.changed&&e.session!=this.env.session_id){this.show_popup_dialog(this.get_label("restoresavedcomposedata").replace("$date",new Date(e.changed).toLocaleString()).replace("$subject",e._subject).replace(/\n/g,"<br/>"),this.get_label("restoremessage"),[{text:this.get_label("restore"),class:"mainaction restore",click:function(){ref.restore_compose_form(d,b),ref.remove_compose_data(d),ref.save_compose_form_local(),$(this).dialog("close")}},{text:this.get_label("delete"),class:"delete",click:function(){ref.remove_compose_data(d),$(this).dialog("close"),g(c)}},{text:this.get_label("ignore"),class:"cancel",click:function(){$(this).dialog("close"),g(c)}}]);break}}},this.init_address_input_events=function(a,b){!b&&this.env.autocomplete_threads>0&&(b={threads:this.env.autocomplete_threads,sources:this.env.autocomplete_sources}),a.keydown(function(a){return ref.ksearch_keydown(a,this,b)}).attr({autocomplete:"off","aria-autocomplete":"list","aria-expanded":"false",role:"combobox"});var c=function(a){ref.ksearch_pane&&a.target===ref.ksearch_pane.get(0)||ref.ksearch_hide()};$(document).on("click",c),document.addEventListener("scroll",c,!0)},this.submit_messageform=function(a,b){var c=this.gui_objects.messageform;if(c){if(!b&&this.env.is_sent)return this.simple_dialog(this.get_label("messageissent"),"",function(){return ref.submit_messageform(!1,!0),!0});if(this.mailvelope_editor)return this.mailvelope_submit_messageform(a,b);var d=this.set_busy(!0,a||b?"savingmessage":"sendingmessage"),e=this.spellcheck_lang(),f=[];$("li",this.gui_objects.attachmentlist).each(function(){f.push(this.id.replace(/^rcmfile/,""))}),$('[name="_attachments"]',c).val(f.join()),c.target=this.get_save_target(d),c._draft.value=a?"1":"",c.action=this.add_url(c.action,"_unlock",d),c.action=this.add_url(c.action,"_framed",1),e&&(c.action=this.add_url(c.action,"_lang",e)),b&&(c.action=this.add_url(c.action,"_saveonly",1)),this.submit_timer=setTimeout(function(){ref.set_busy(!1,null,d),ref.display_message("requesttimedout","error")},1e3*this.env.request_timeout),c.submit()}},this.compose_recipient_select=function(a){var b,c,d=0,e=a.get_selection();for(c=0;c<e.length;c++)b=e[c],this.env.contactdata[b]&&d++;this.enable_command("add-recipient",d)},this.compose_add_recipient=function(a){a||(a=$(this.env.focused_field).filter(":visible"),a=a.length?a.attr("id").replace("_",""):"to");var b=[],c=$("#_"+a),d=this.contact_list.get_selection();if(this.contact_list&&d.length){var e,f,g,h;for(g=0;g<d.length;g++)if((h=d[g])&&(e=this.env.contactdata[h])){if(f=e.name||e,"E"==h.charAt(0)&&c.length){f="​"+f+"​";var i=h.substr(1);this.group2expand[i]={name:f,input:c.get(0)},this.http_request("group-expand",{_source:e.source||this.env.source,_gid:i},!1)}b.push(f)}}if(b.length&&c.length){var j=c.val();j&&!/[,;]\s*$/.test(j)&&(j+=", "),c.val(j+b.join(", ")+", ").change(),this.triggerEvent("add-recipient",{field:a,recipients:b})}return b.length},this.check_compose_input=function(a){var b,c=$("[name='_subject']");for(b in this.env.attachments)if("object"==typeof this.env.attachments[b]&&!this.env.attachments[b].complete)return this.alert_dialog(this.get_label("notuploadedwarning")),!1;if(!this.env.nosubject_warned&&""==c.val()){var d,e=$("<input>").attr({type:"text",size:40,"data-submit":"true"}),f=$('<div class="prompt">').append($('<p class="message">').text(this.get_label("nosubjectwarning"))).append(e),g=function(){c.val(e.val()),d.dialog("close"),ref.check_compose_input(a)&&ref.command(a,{nocheck:!0})};return d=this.show_popup_dialog(f,this.get_label("nosubjecttitle"),[{text:this.get_label("sendmessage"),class:"mainaction send",click:function(){g()}},{text:this.get_label("cancel"),class:"cancel",click:function(){c.focus(),d.dialog("close")}}],{dialogClass:"warning"}),this.env.nosubject_warned=!0,!1}return this.mailvelope_editor||this.editor.get_content()||confirm(this.get_label("nobodywarning"))?!!this.check_compose_address_fields(a)&&(this.editor.save(),!0):(this.editor.focus(),!1)},this.check_compose_address_fields=function(a,b){b||(b=window.document);var c,d,e=this.env.max_disclosed_recipients,f=$("[name='_to']",b),g=$("[name='_cc']",b),h=$("[name='_bcc']",b),i=$("[name='_from']",b),j=function(a){return a=$.map(a,function(a){return a=a.val().trim(),a.length?a:null}),a.join(",").replace(/^[\s,;]+/,"").replace(/[\s,;]+$/,"")};if("text"==i.prop("type")&&!rcube_check_email(i.val(),!0))return this.alert_dialog(this.get_label("nosenderwarning"),function(){i.focus()}),!1;if(!rcube_check_email(j([f,g,h]),!0))return this.alert_dialog(this.get_label("norecipientwarning"),function(){f.focus()}),!1;if(e&&!this.env.disclosed_recipients_warned&&rcube_check_email(c=j([f,g]),!0,!0)>e){var k=function(b){if(b){var e=h.val();h.val((e?e+", ":"")+c).change(),f.val("").change(),g.val("").change()}d.dialog("close"),"function"==typeof a?a():a&&ref.command(a,{nocheck:!0})};return d=this.show_popup_dialog(this.get_label("disclosedrecipwarning"),this.get_label("disclosedreciptitle"),[{text:this.get_label("sendmessage"),click:function(){k(!1)},class:"mainaction"},{text:this.get_label("bccinstead"),click:function(){k(!0)}},{text:this.get_label("cancel"),click:function(){d.dialog("close")},class:"cancel"}],{dialogClass:"warning"}),this.env.disclosed_recipients_warned=!0,!1}return!0},this.toggle_editor=function(a,b,c){var d,e=this.editor.toggle(a.html,a.noconvert||!1),f=$("#"+this.editor.id).data("control")||$(c?c.target:[]);return d=e?a.html?"html":"plain":a.html?"plain":"html",$("[name='_is_html']").val("html"==d?1:0),f.is("[type=checkbox]")?f.prop("checked","html"==d):f.val(d),e},this.insert_response=function(a){if("object"==typeof a){var b={};b[a.is_html?"html":"text"]=a.data,this.editor.replace(b),this.display_message("responseinserted","confirmation")}else{var c=this.display_message("","loading");this.http_get("settings/response-get",{_id:a,_is_html:this.editor.is_html()?1:0},c)}},this.spellcheck_state=function(){var a=this.editor.spellcheck_state();return $.each(this.buttons.spellcheck||[],function(b,c){$("#"+c.id)[a?"addClass":"removeClass"]("selected")}),a},this.spellcheck_lang=function(){return this.editor.get_language()},this.spellcheck_lang_set=function(a){this.editor.set_language(a)},this.spellcheck_resume=function(a){this.editor.spellcheck_resume(a)},this.set_draft_id=function(a){if(a&&a!=this.env.draft_id){var b={task:"mail",action:""},c=this.opener(!1,b)||this.opener(!0,b);c&&c.env.mailbox==this.env.drafts_mailbox&&c.command("checkmail"),this.env.draft_id=a,$("[name='_draft_saveid']").val(a)}this.remove_compose_data(this.env.compose_id),this.compose_skip_unsavedcheck=!1},this.get_save_target=function(a){return this.dummy_iframe("savetarget","javascript:false;").on("load error",function(){a&&0==$(this).contents().find('meta[name="generator"][content="Roundcube"]').length&&(ref.iframe_loaded(a),ref.display_message("connerror","error")),$(this).remove()}),"savetarget"},this.auto_save_start=function(){this.env.draft_autosave&&(this.save_timer=setTimeout(function(){ref.command("savedraft")},1e3*this.env.draft_autosave)),!this.local_save_timer&&window.localStorage&&this.env.save_localstorage&&(this.compose_type_activity=this.compose_type_activity_last=0,$(document).keypress(function(a){ref.compose_type_activity++}),this.local_save_timer=setInterval(function(){ref.compose_type_activity>ref.compose_type_activity_last&&(ref.save_compose_form_local(),ref.compose_type_activity_last=ref.compose_type_activity)},5e3),$(window).on("unload",function(){ref.env.server_error||ref.remove_compose_data(ref.env.compose_id)})),window.onbeforeunload||(window.onbeforeunload=function(){if(!ref.compose_skip_unsavedcheck&&ref.cmp_hash!=ref.compose_field_hash())return ref.get_label("notsentwarning")}),this.busy=!1},this.compose_field_hash=function(a){var b,c,d,e="",f=["to","cc","bcc","subject"];for(b=0;b<f.length;b++)(d=$('[name="_'+f[b]+'"]').val())&&(e+=d+":");e+=this.editor.get_content({refresh:!1});for(c in this.env.attachments)e+=c;return this.mailvelope_editor&&(e+=";"+(new Date).getTime()),a&&(this.cmp_hash=e),e},this.save_compose_form_local=function(){if(this.env.save_localstorage){var a={session:this.env.session_id,changed:(new Date).getTime()},b=!0;if(this.editor.save(),this.env.draft_id&&(a.draft_id=this.env.draft_id),this.env.reply_msgid&&(a.reply_msgid=this.env.reply_msgid),$("input, select, textarea",this.gui_objects.messageform).each(function(c,d){switch(d.tagName.toLowerCase()){case"input":if("button"==d.type||"submit"==d.type||"hidden"==d.type&&"_is_html"!=d.name)break;a[d.name]="checkbox"!=d.type||d.checked?$(d).val():"",""!=a[d.name]&&"hidden"!=d.type&&(b=!1);break;case"select":a[d.name]=$("option:checked",d).val();break;default:a[d.name]=$(d).val(),""!=a[d.name]&&(b=!1)}}),!b){var c=this.local_storage_get_item("compose.index",[]),d=this.env.compose_id;$.inArray(d,c)<0&&c.push(d),this.local_storage_set_item("compose."+d,a,!0),this.local_storage_set_item("compose.index",c)}}},this.restore_compose_form=function(a,b){var c=this.local_storage_get_item("compose."+a,!0);c&&"object"==typeof c&&($.each(c,function(a,b){if("_"==a[0]){var c=$("[name="+a+"]");c[0]&&"checkbox"==c[0].type?c.prop("checked",""!=b):c.val(b).change()}}),("1"==c._is_html&&!b||"1"!=c._is_html&&b)&&this.command("toggle-editor",{id:this.env.composebody,html:!b,noconvert:!0}))},this.remove_compose_data=function(a){var b=this.local_storage_get_item("compose.index",[]);$.inArray(a,b)>=0&&(this.local_storage_remove_item("compose."+a),this.local_storage_set_item("compose.index",$.grep(b,function(b,c){return b!=a})))},this.clear_compose_data=function(){var a,b=this.local_storage_get_item("compose.index",[]);for(a=0;a<b.length;a++)this.local_storage_remove_item("compose."+b[a]);this.local_storage_remove_item("compose.index")},this.change_identity=function(a,b){if(!a||!a.options)return!1;var c=$(a).val(),d=this.env.signatures&&this.env.signatures[c],e=this.env.identity,f=b||this.env.show_sig;return d?(this.enable_command("insert-sig",!0),this.env.compose_commands.push("insert-sig"),d=!0):this.enable_command("insert-sig",!1),this.env.identities_initialized||(this.env.identities_initialized=!0,this.env.show_sig_later&&(this.env.show_sig=!0),!this.env.opened_extwin)?($.each(["replyto","bcc"],function(){var a,b=this,d=e&&ref.env.identities[e]?ref.env.identities[e][b]:"",f=c&&ref.env.identities[c]?ref.env.identities[c][b]:"",g=$('[name="_'+b+'"]'),h=g.val();d&&h&&(a=new RegExp("\\s*"+RegExp.escape(d)+"\\s*"),h=h.replace(a,"")),h=String(h).replace(/[,;]\s*[,;]/g,",").replace(/^[\s,;]+/,""),f&&-1==h.indexOf(f)&&-1==h.indexOf(f.replace(/"/g,""))&&(h&&(h=h.replace(/[,;\s]+$/,"")+", "),h+=f+", "),(d||f)&&g.val(h).change()}),this.editor&&this.editor.change_signature(c,f),b&&d&&this.display_message("siginserted","confirmation"),this.env.identity=c,this.triggerEvent("change_identity"),!0):void 0},this.upload_input=function(a){$("#"+a+' input[type="file"]').click()},this.upload_file=function(a,b,c){if(a){var d,e=[];return $("input",a).each(function(){if(this.files){d=this.name;for(var a=0;a<this.files.length;a++)e.push(this.files[a])}}),this.file_upload(e,{_id:this.env.compose_id||""},{name:d,action:b,lock:c})}},this.add2attachment_list=function(a,b,c){if(c&&this.triggerEvent("fileuploaded",{name:a,attachment:b,id:c}),c&&this.env.attachments[c]&&delete this.env.attachments[c],this.env.attachments[a]=b,!this.gui_objects.attachmentlist)return!1;var d,e,f=$("<li>");!b.complete&&b.html.indexOf("<")<0&&(b.html='<span class="uploading">'+b.html+"</span>"),!b.complete&&this.env.loadingicon&&(b.html='<img src="'+this.env.loadingicon+'" alt="" class="uploading" />'+b.html),b.complete||(d=this.get_label("cancel"),b.html='<a title="'+d+'" onclick="return rcmail.cancel_attachment_upload(\''+a+'\');" href="#cancelupload" class="cancelupload">'+(this.env.cancelicon?'<img src="'+this.env.cancelicon+'" alt="'+d+'" />':'<span class="inner">'+d+"</span>")+"</a>"+b.html),f.attr("id",a).addClass(b.classname).html(b.html).find(".attachment-name").on("mouseover",function(){rcube_webmail.long_subject_title_ex(this)}),c&&(e=document.getElementById(c))?f.replaceAll(e):f.appendTo(this.gui_objects.attachmentlist);var g=$(this.gui_objects.attachmentlist).attr("data-tabindex")||"0";return f.find("a").attr("tabindex",g),this.triggerEvent("fileappended",{name:a,attachment:b,id:c,item:f}),!0},this.remove_from_attachment_list=function(a){delete this.env.attachments[a],$("#"+a).remove()},this.remove_attachment=function(a){return a&&this.env.attachments[a]&&this.http_post("remove-attachment",{_id:this.env.compose_id,_file:a}),!1},this.cancel_attachment_upload=function(a){return!(!a||!this.uploads[a])&&(this.remove_from_attachment_list(a),this.uploads[a].abort(),!1)},this.rename_attachment=function(a){var b=this.env.attachments[a];if(b){var c=$("<input>").attr({type:"text",size:50}).val(b.name),d=$("<label>").text(this.get_label("namex")).append(c);this.simple_dialog(d,"attachmentrename",function(){var d;if((d=c.val())&&d!=b.name)return ref.http_post("rename-attachment",{_id:ref.env.compose_id,_file:a,_name:d},ref.set_busy(!0,"loading")),!0})}},this.rename_attachment_handler=function(a,b){var c=this.env.attachments[a];c&&b&&(c.name=b,$("#"+a+" .attachment-name").text(b).attr("title",""))},this.add_contact=function(a,b,c){a&&this.http_post("addcontact",{_address:a,_reload:b,_source:c})},this.qsearch=function(a){if(""!=a||$(this.gui_objects.qsearchbox).val()||$(this.gui_objects.search_interval).val()){var b,c=this.set_busy(!0,"searching"),d=this.search_params(a),e="compose"==this.env.action&&this.contact_list?"search-contacts":"search";return this.message_list?this.clear_message_list():this.contact_list&&this.list_contacts_clear(),this.env.source&&(d._source=this.env.source),this.env.group&&(d._gid=this.env.group),this.env.current_page=1,b=this.http_request(e,d,c),this.env.qsearch={lock:c,request:b},this.enable_command("set-listmode",this.env.threads&&"base"==(this.env.search_scope||"base")),!0}return!1},this.continue_search=function(a){var b=this.set_busy(!0,"stillsearching");setTimeout(function(){var c=ref.search_params();c._continue=a,ref.env.qsearch={lock:b,request:ref.http_request("search",c,b)}},100)},this.search_params=function(a,b){var c,d={},e=[],f=this.env.search_mods,g=this.env.search_scope||"base",h=this.env.mailbox;if(!b&&this.gui_objects.search_filter&&(b=this.gui_objects.search_filter.value),!a&&this.gui_objects.qsearchbox&&(a=this.gui_objects.qsearchbox.value),this.gui_objects.search_interval&&(d._interval=$(this.gui_objects.search_interval).val()),a&&(d._q=a,f&&this.message_list&&(f=f[h]||f["*"]),f)){for(c in f)e.push(c);d._headers=e.join(",")}return d._layout=this.env.layout,d._filter=b,d._scope=g,d._mbox=h,d},this.reset_search_filter=function(){this.filter_disabled=!0,this.gui_objects.search_filter&&$(this.gui_objects.search_filter).val("ALL").change(),this.filter_disabled=!1},this.reset_qsearch=function(a){this.gui_objects.qsearchbox&&(this.gui_objects.qsearchbox.value=""),this.gui_objects.search_interval&&$(this.gui_objects.search_interval).val(""),this.env.qsearch&&this.abort_request(this.env.qsearch),a&&(this.env.search_scope="base",this.reset_search_filter()),this.env.qsearch=null,this.env.search_request=null,this.env.search_id=null,this.select_all_mode=!1,this.enable_command("set-listmode",this.env.threads)},this.set_searchscope=function(a){this.env.search_scope=a},this.set_searchinterval=function(a){this.env.search_interval=a},this.set_searchmods=function(a){var b=this.env.mailbox;this.env.search_scope;this.env.search_mods||(this.env.search_mods={}),b&&(this.env.search_mods[b]=a)},this.is_multifolder_listing=function(){return void 0!==this.env.multifolder_listing?this.env.multifolder_listing:this.env.search_request&&"base"!=(this.env.search_scope||"base")},this.sent_successfully=function(a,b,c,d){if(this.display_message(b,a),this.compose_skip_unsavedcheck=!0,this.env.extwin){d||this.lock_form(this.gui_objects.messageform);var e={task:"mail",action:""},f=this.opener(!1,e)||this.opener(!0,e);f&&(f.display_message(b,a),c&&$.inArray(f.env.mailbox,c)>=0&&f.command("checkmail")),d||setTimeout(function(){window.close()},1e3)}else d||setTimeout(function(){ref.list_mailbox()},500);d&&(this.env.is_sent=!0)},this.image_rotate=function(){var a=this.image_style?this.image_style.rotate||0:0;this.image_style.rotate=a>180?0:a+90,this.apply_image_style()},this.image_scale=function(a){var b=this.image_style?this.image_style.scale||1:1;this.image_style.scale=Math.max(.1,b+.1*("-"==a?-1:1)),this.apply_image_style()},this.apply_image_style=function(){var a=[],b=$(this.gui_objects.messagepartframe).contents().find("img");$.each({scale:"",rotate:"deg"},function(b,c){var d=ref.image_style[b];d&&a.push(b+"("+d+c+")")}),b.css("transform",a.join(" "))},this.import_state_set=function(a){if(this.import_dialog){this.import_state=a;var b=$(this.import_dialog).parent().find(".ui-dialog-buttonset > button").first();"error"!=a?(b.hide(),b.next().text(this.gettext("close")).focus()):b.prop("disabled",!1)}},this.ksearch_keydown=function(a,b,c){this.ksearch_timer&&clearTimeout(this.ksearch_timer);var d=rcube_event.get_keycode(a);switch(d){case 38:case 40:if(!this.ksearch_visible())return;var e=38==d?1:0,f=this.ksearch_pane.find("li.selected")[0];return f||(f=this.ksearch_pane.__ul.firstChild),f&&this.ksearch_select(e?f.previousSibling:f.nextSibling),rcube_event.cancel(a);case 9:if(rcube_event.get_modifier(a)==SHIFT_KEY||!this.ksearch_visible())return void this.ksearch_hide();case 13:return!!this.ksearch_visible()&&(this.insert_recipient(this.ksearch_selected),this.ksearch_hide(),9==d?null:rcube_event.cancel(a));case 27:return void this.ksearch_hide();case 37:case 39:return}return this.ksearch_timer=setTimeout(function(){ref.ksearch_get_results(c)},200),this.ksearch_input=b,!0},this.ksearch_visible=function(){return null!==this.ksearch_selected&&void 0!==this.ksearch_selected&&this.ksearch_value},this.ksearch_select=function(a){this.ksearch_pane&&a&&this.ksearch_pane.find("li.selected").removeClass("selected").removeAttr("aria-selected"),a&&($(a).addClass("selected").attr("aria-selected","true"),this.ksearch_selected=a._rcm_id,$(this.ksearch_input).attr("aria-activedescendant","rcmkSearchItem"+this.ksearch_selected))},this.insert_recipient=function(a){if(null!==a&&this.env.contacts[a]&&this.ksearch_input){var b=!1,c="",d=", ",e=this.env.contacts[a];if(this.ksearch_destroy(),"object"==typeof e&&"group"==e.type&&!e.email&&e.id){var f="​"+e.name+"​";c=f+d,this.group2expand[e.id]={name:f,input:this.ksearch_input},this.http_request("mail/group-expand",{_source:e.source,_gid:e.id},!1)}else"object"==typeof e&&e.name?(c=e.name+d,b=!0):"string"==typeof e&&(c=e+d,b=!0);this.ksearch_input_replace(this.ksearch_value,c,null,b),b&&(this.triggerEvent("autocomplete_insert",{field:this.ksearch_input,insert:c,data:e,search:this.ksearch_value_last,result_type:"person"}),this.ksearch_value_last=null,this.compose_type_activity++)}},this.replace_group_recipients=function(a,b){var c=this.group2expand[a];c&&(this.ksearch_input_replace(c.name,b,c.input),this.triggerEvent("autocomplete_insert",{field:c.input,insert:b,data:c,search:this.ksearch_value_last,result_type:"group"}),this.ksearch_value_last=null,this.group2expand[a]=null,this.compose_type_activity++)},this.ksearch_get_results=function(a){this.ksearch_pane&&this.ksearch_pane.is(":visible")&&this.ksearch_pane.hide();var b=this.ksearch_input_get(),c=this.env.autocomplete_min_length,d=this.ksearch_data;if((b=b.trim())!=this.ksearch_value){if(this.ksearch_destroy(),b.length&&b.length<c)return void(this.ksearch_info||(this.ksearch_info=this.display_message(this.get_label("autocompletechars").replace("$min",c))));var e=this.ksearch_value;if(this.ksearch_value=b,this.ksearch_value_last=b,b.length&&(!(e&&e.length&&b.startsWith(e)&&(!d||d.num<=0)&&this.env.contacts)||this.env.contacts.length)){var f=a&&a.sources?a.sources:[""],g=this.multi_thread_http_request({items:f,threads:a&&a.threads?a.threads:1,action:a&&a.action?a.action:"mail/autocomplete",postdata:{_search:b,_source:"%s"},lock:this.display_message("searching","loading")});this.ksearch_data={id:g,sources:f.slice(),num:f.length}}}},this.ksearch_query_results=function(a,b,c){if(this.multi_thread_http_response(a,c),this.ksearch_value&&(!this.ksearch_input||b==this.ksearch_value)){var d,e,f,g,h,i,j=this.is_framed(),k=this.ksearch_value,l=this.env.autocomplete_max?this.env.autocomplete_max:15;if(this.ksearch_pane||(g=$("<ul>"),this.ksearch_pane=$("<div>").attr({id:"rcmKSearchpane",role:"listbox",class:"select-menu inline"}).css({position:"absolute","z-index":3e4}).append(g).appendTo(j?parent.document.body:document.body),this.ksearch_pane.__ul=g[0],this.triggerEvent("autocomplete_create",{obj:this.ksearch_pane})),g=this.ksearch_pane.__ul,c&&this.ksearch_pane.data("reqid")==c)l-=g.childNodes.length;else{this.ksearch_pane.data("reqid",c),1,g.innerHTML="",this.env.contacts=[];var m=$("html").is(".layout-small,.layout-phone")&&1==$(this.ksearch_input).parents(".ac-input").length,n=m?$(this.ksearch_input).parents(".ac-input")[0]:$(this.ksearch_input)[0],o=$(n).offset();if(o.left-=$(document.documentElement).scrollLeft(),o.top-=$(document.documentElement).scrollTop(),j)try{parent.$("iframe").each(function(){if(this.contentWindow==window){var a=$(this).offset();o.left+=a.left,o.top+=a.top}})}catch(a){}var p=$(j?parent:window).width(),q=$(n).outerWidth(),r=p-o.left>200?o.left:p-200,s=o.top+n.offsetHeight+1,t=Math.min(400,p-r);this.ksearch_pane.css({left:(m?o.left:r)+"px",top:s+"px",maxWidth:(m?q:t)+"px",minWidth:"200px",width:m?q+"px":"auto",display:"none"})}if(a&&(f=a.length))for(d=0;d<f&&l>0;d++)h="object"==typeof a[d]?a[d].display||a[d].name:a[d],i="object"==typeof a[d]?a[d].type:"",e=d+this.env.contacts.length,$("<li>").attr({id:"rcmkSearchItem"+e,role:"option"}).html('<i class="icon"></i>'+this.quote_html(h.replace(new RegExp("("+RegExp.escape(k)+")","ig"),"##$1%%")).replace(/##([^%]+)%%/g,"<b>$1</b>")).addClass(i||"").appendTo(g).mouseover(function(){ref.ksearch_select(this)}).mouseup(function(){ref.ksearch_click(this)}).get(0)._rcm_id=e,l-=1;g.childNodes.length&&($(this.ksearch_input).attr({"aria-haspopup":"true","aria-expanded":"true","aria-owns":"rcmKSearchpane"}),this.ksearch_pane.show(),this.env.contacts.length||this.ksearch_select($("li",g)[0])),f&&(this.env.contacts=this.env.contacts.concat(a)),this.ksearch_data.id==c&&this.ksearch_data.num--}},this.ksearch_input_get=function(){if(!this.ksearch_input)return"";var a=this.get_caret_pos(this.ksearch_input);return this.ksearch_input.value.substr(0,a).split(/[,;]/).pop()},this.ksearch_input_replace=function(a,b,c,d){if(this.ksearch_input||c){c||(c=this.ksearch_input);var e=this.get_caret_pos(c),f=c.value.lastIndexOf(a,e),g=c.value.substring(0,f),h=c.value.substring(f+a.length,c.value.length);c.value=g+b+h,this.set_caret_pos(c,e+b.length-a.length),$(c).trigger("change",[!0,d])}},this.ksearch_click=function(a){this.ksearch_input&&this.ksearch_input.focus(),this.insert_recipient(a._rcm_id),this.ksearch_hide()},this.ksearch_blur=function(){this.ksearch_timer&&clearTimeout(this.ksearch_timer),this.ksearch_input=null,this.ksearch_hide()},this.ksearch_hide=function(){this.ksearch_selected=null,this.ksearch_value="",this.ksearch_pane&&this.ksearch_pane.hide(),$(this.ksearch_input).attr({"aria-haspopup":"false","aria-expanded":"false"}).removeAttr("aria-activedescendant").removeAttr("aria-owns"),this.ksearch_destroy()},this.ksearch_destroy=function(){this.ksearch_data&&this.multi_thread_request_abort(this.ksearch_data.id),this.ksearch_info&&this.hide_message(this.ksearch_info),this.ksearch_msg&&this.hide_message(this.ksearch_msg),this.ksearch_data=null,this.ksearch_info=null,this.ksearch_msg=null},this.contactlist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b,c,d=0,e=!1,f=!1,g=!1,h=a.get_selection().length,i=this.env.source?this.env.address_sources[this.env.source]:null;return this.env.contentframe&&!a.multi_selecting&&(b=a.get_single_selection())?this.preview_timer=setTimeout(function(){ref.load_contact(b,"show")},this.preview_delay_click):this.env.contentframe&&this.show_contentframe(!1),h&&(a.draggable=!1,this.env.selection_sources=[],i&&this.env.selection_sources.push(this.env.source),$.each(a.get_selection(),function(b,c){var d,g,h=a.data[c];i?(e=e||!i.readonly&&!h.readonly,f=f||!0===i.deletable):(g=String(c).replace(/^[^-]+-/,""),(d=g?ref.env.address_sources[g]:null)&&(e=e||!d.readonly&&!h.readonly,f=f||!0===d.deletable,ref.env.selection_sources.push(g))),"group"!=h._type&&(a.draggable=!0)}),this.env.selection_sources=$.unique(this.env.selection_sources),i&&i.groups&&$.each(this.env.contactgroups,function(){this.source===ref.env.source&&d++}),c=$.map(this.env.address_sources,function(a,b){return a.readonly?null:b}),g=$.grep(c,function(a){return jQuery.inArray(a,ref.env.selection_sources)<0}).length>0),this.enable_command("group-assign-selected",d>0&&e),this.enable_command("group-remove-selected",this.env.group&&e),this.enable_command("print","qrcode",1==h),this.enable_command("export-selected",h>0),this.enable_command("edit",b&&e),this.enable_command("delete","move",e||f),this.enable_command("copy",g),!1},this.list_contacts=function(a,b,c,d){var e,f,g=-1,h={},i=void 0===a&&void 0===b&&void 0===c,j=window;if(a||(a=this.env.source),i&&(b=this.env.group),a!=this.env.source?(c=this.env.current_page=1,this.reset_qsearch()):i||b==this.env.group||(c=this.env.current_page=1),this.env.search_id?f="S"+this.env.search_id:this.env.search_request||(f=b?"G"+a+b:a),this.env.source=this.env.last_source=a,this.env.group=this.env.last_group=b,$.each(this.env.address_group_stack,function(a,b){if(ref.env.group==b.id)return g=a,!1}),this.env.address_group_stack=g<0?[]:this.env.address_group_stack.slice(0,g),this.destroy_entity_selector("contactgroup-selector"),this.env.group?(d||(d={}),d.id=this.env.group,this.env.address_group_stack.push(d),f="G"+a+this.env.address_group_stack[0].id):this.gui_objects.addresslist_title&&$(this.gui_objects.addresslist_title).text(this.get_label("contacts")),this.env.search_id||this.select_folder(f,"",!0),this.gui_objects.contactslist)return void this.list_contacts_remote(a,b,c);(e=this.get_frame_window(this.env.contentframe))&&(j=e,h._framed=1),b&&(h._gid=b),c&&(h._page=c),a&&(h._source=a),this.env.search_request&&(h._search=this.env.search_request),this.set_busy(!0,"loading"),this.location_href(h,j)},this.list_contacts_remote=function(a,b,c){this.list_contacts_clear();var d={},e=this.set_busy(!0,"loading");a&&(d._source=a),c&&(d._page=c),b&&(d._gid=b),this.env.source=a,this.env.group=b,this.env.search_request&&(d._search=this.env.search_request),this.http_request("mail"==this.env.task?"list-contacts":"list",d,e),"mail"!=this.env.task&&this.update_state({_source:a,_page:c&&c>1?c:null,_gid:b})},this.list_contacts_clear=function(){this.contact_list.data={},this.contact_list.clear(!0),this.show_contentframe(!1),this.enable_command("delete","move","copy","print",!1)},this.set_group_prop=function(a){if(this.gui_objects.addresslist_title){var b=$(this.gui_objects.addresslist_title).html("");if(this.env.address_group_stack.length>1||1==this.env.address_group_stack.length&&this.env.address_group_stack[0].search_request){var c=$('<a href="#list">...</a>').attr({title:this.get_label("uponelevel"),class:"poplink"}).click(function(){return ref.command("popgroup","",this)});b.append(c).append("&nbsp;&raquo;&nbsp;")}b.append($("<span>").text(a?a.name:this.get_label("contacts")))}},this.load_contact=function(a,b,c){var d,e={},f=window,g=this.contact_list?this.contact_list.data[a]:null;if(d=this.get_frame_window(this.env.contentframe))e._framed=1,f=d,this.show_contentframe(!0),a||this.contact_list.clear_selection(),this.enable_command("export-selected","print",g&&"group"!=g._type);else if(c)return!1;return!b||!a&&"add"!=b||this.drag_active||(this.env.group&&(e._gid=this.env.group),this.env.search_request&&(e._search=this.env.search_request),a&&(e._cid=this.preview_id=a),e._action=b,e._source=this.env.source,this.location_href(e,f,!0)),!0},this.group_member_change=function(a,b,c,d){"add"!=a&&(a="del");var e=this.display_message("add"==a?"addingmember":"removingmember","loading"),f={_cid:b,_source:c,_gid:d};this.http_post("group-"+a+"members",f,e)},this.contacts_drag_menu=function(a,b){var c="group"==b.type?b.source:b.id,d=this.env.source;if(!this.env.address_sources[c]||this.env.address_sources[c].readonly)return!0;if(""==d&&1==this.env.selection_sources.length&&(d=this.env.selection_sources[0]),"group"==b.type&&c==d){var e=this.contact_list.get_selection().join(",");return this.group_member_change("add",e,c,b.id),!0}return this.commands.move||rcube_event.get_modifier(a)==SHIFT_KEY?this.drag_menu(a,b):(this.copy_contacts(b),!0)},this.copy_contacts=function(a,b,c){if(!a)return c=this.contact_list.get_selection(),this.addressbook_selector(b,function(a,b){var a=$(b).data("source")?ref.env.contactgroups["G"+$(b).data("source")+$(b).data("gid")]:ref.env.address_sources[a];ref.copy_contacts(a,null,c)});var d="group"==a.type?a.source:a.id,e=this.env.source,f=this.env.group?this.env.group:"";if((c=c?c.join(","):this.contact_list.get_selection().join(","))&&this.env.address_sources[d]&&!this.env.address_sources[d].readonly)if(""==e&&1==this.env.selection_sources.length&&(e=this.env.selection_sources[0]),"group"==a.type){if(d==e)return;var g=this.display_message("copyingcontact","loading"),h={_cid:c,_source:this.env.source,_to:d,_togid:a.id,_gid:f};this.http_post("copy",h,g)}else if(a.id!=e){var g=this.display_message("copyingcontact","loading"),h={_cid:c,_source:this.env.source,_to:a.id,_gid:f};this.http_post("copy",h,g)}},this.move_contacts=function(a,b,c){if(!a)return c=this.contact_list.get_selection(),this.addressbook_selector(b,function(a,b){var a=$(b).data("source")?ref.env.contactgroups["G"+$(b).data("source")+$(b).data("gid")]:ref.env.address_sources[a];ref.move_contacts(a,null,c)});var d="group"==a.type?a.source:a.id,e=this.env.source;this.env.group&&this.env.group;if(this.env.address_sources[d]&&!this.env.address_sources[d].readonly)if(c||(c=this.contact_list.get_selection()),""==e&&1==this.env.selection_sources.length&&(e=this.env.selection_sources[0]),"group"==a.type){if(d==e)return;this._with_selected_contacts("move",{_to:d,_togid:a.id,_cid:c})}else a.id!=e&&this._with_selected_contacts("move",{_to:a.id,_cid:c})},this.delete_contacts=function(){if(this.env.source&&this.env.address_sources[this.env.source].undelete)this._with_selected_contacts("delete",{_cid:this.contact_list.get_selection()});else{var a=this.contact_list.get_selection();this.confirm_dialog(this.get_label("deletecontactconfirm"),"delete",function(){ref._with_selected_contacts("delete",{_cid:a})})}},this._with_selected_contacts=function(a,b){var c=b._cid;if(c.length||this.env.cid){var d,e=[],f="delete"==a?"contactdeleting":"movingcontact",g=this.display_message(f,"loading"),h=this.check_display_next();if(this.env.cid)e.push(this.env.cid);else{for(d=0;d<c.length;d++)id=c[d],e.push(id),this.contact_list.remove_row(id,h&&d==c.length-1);h||this.contact_list.clear_selection()}return b||(b={}),b._source=this.env.source,b._from=this.env.action,b._cid=e.join(","),this.env.group&&(b._gid=this.env.group),this.env.search_request&&(b._search=this.env.search_request),this.http_post(a,b,g),!0}},this.update_contact_row=function(a,b,c,d,e){var f=this.contact_list;a=this.html_identifier(a),f.rows[a]||(a=a+"-"+d,c&&(c=c+"-"+d)),f.update_row(a,b,c,!0),f.data[a]=e},this.add_contact_row=function(a,b,c,d){if(!this.gui_objects.contactslist)return!1;var e,f,g=this.contact_list,h={cols:[]};h.id="rcmrow"+this.html_identifier(a),h.className="contact "+(c||""),g.in_selection(a)&&(h.className+=" selected");for(e in b)f={},f.className=String(e).toLowerCase(),f.innerHTML=b[e],h.cols.push(f);g.data[a]=d,g.insert_row(h),this.enable_command("export",g.rowcount>0)},this.init_contact_form=function(){var a;if(this.env.coltypes){this.set_photo_actions($("#ff_photo").val());for(a in this.env.coltypes)this.init_edit_field(a,null)}$(".contactfieldgroup .row a.deletebutton").click(function(){return ref.delete_edit_field(this),!1}),$("select.addfieldmenu").change(function(){ref.insert_edit_field($(this).val(),$(this).attr("rel"),this),this.selectedIndex=0}),$.datepicker&&this.env.date_format&&($.datepicker.setDefaults({dateFormat:this.env.date_format,changeMonth:!0,changeYear:!0,yearRange:"-120:+10",showOtherMonths:!0,selectOtherMonths:!0}),$("input.datepicker").datepicker()),"search"==this.env.action&&$(this.gui_objects.editform).append($('<input type="submit">').hide()).submit(function(){return $("input.mainaction").click(),!1})},this.group_create=function(){var a=$("<input>").attr({type:"text","data-submit":"true"}),b=$("<label>").text(this.get_label("namex")).append(a),c=this.env.source;this.simple_dialog(b,"newgroup",function(){var b;if(b=a.val())return ref.http_post("group-create",{_source:c,_name:b},ref.set_busy(!0,"loading")),!0})},this.group_rename=function(){if(this.env.group){var a=this.env.contactgroups["G"+this.env.source+this.env.group].name,b=$("<input>").attr({type:"text","data-submit":"true"}).val(a),c=$("<label>").text(this.get_label("namex")).append(b),d=this.env.source,e=this.env.group;this.simple_dialog(c,"grouprename",function(){var c;if((c=b.val())&&c!=a)return ref.http_post("group-rename",{_source:d,_gid:e,_name:c},ref.set_busy(!0,"loading")),!0})}},this.group_delete=function(){if(this.env.group){var a=this.env.group;this.confirm_dialog(this.get_label("deletegroupconfirm"),"delete",function(){var b=ref.set_busy(!0,"groupdeleting");ref.http_post("group-delete",{_source:ref.env.source,_gid:a},b)})}},this.remove_group_item=function(a){var b="G"+a.source+a.id;this.treelist.remove(b)&&(this.destroy_entity_selector("addressbook-selector"),this.destroy_entity_selector("contactgroup-selector"),this.triggerEvent("group_delete",{source:a.source,id:a.id}),delete this.env.contactfolders[b],delete this.env.contactgroups[b]),a.source==this.env.source&&a.id==this.env.group&&this.list_contacts(a.source,0)},this.group_assign_selected=function(a,b,c){var d=ref.contact_list.get_selection(),e=ref.env.source;this.contactgroup_selector(c,function(a){ref.group_member_change("add",d,e,a)})},this.group_remove_selected=function(){this.http_post("group-delmembers",{_cid:this.contact_list.get_selection(),_source:this.env.source,_gid:this.env.group})},this.remove_group_contacts=function(a){if(void 0!==this.env.group&&this.env.group===a.gid){var b,c=this.contact_list.get_selection(),d=this.check_display_next();for(b=0;b<c.length;b++)id=c[b],this.contact_list.remove_row(id,d&&b==c.length-1);d||this.contact_list.clear_selection()}},this.insert_contact_group=function(a){a.type="group";var b="G"+a.source+a.id,c=$("<a>").attr({href:"#",rel:a.source+":"+a.id}).click(function(){return ref.command("listgroup",a,this)}).text(a.name);this.env.contactfolders[b]=this.env.contactgroups[b]=a,this.treelist.insert({id:b,html:c,classes:["contactgroup"]},a.source,"contactgroup"),this.destroy_entity_selector("addressbook-selector"),this.destroy_entity_selector("contactgroup-selector"),this.triggerEvent("group_insert",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b)})},this.update_contact_group=function(a){var b="G"+a.source+a.id,c={};if(a.newid){var d="G"+a.source+a.newid,e=$.extend({},a);this.env.contactfolders[d]=this.env.contactfolders[b],this.env.contactfolders[d].id=a.newid,this.env.group=a.newid,delete this.env.contactfolders[b],delete this.env.contactgroups[b],e.id=a.newid,e.type="group",c.id=d,c.html=$("<a>").attr({href:"#",rel:a.source+":"+a.newid}).click(function(){return ref.command("listgroup",e,this)}).text(a.name)}else $(this.treelist.get_item(b)).children().first().text(a.name),this.env.contactfolders[b].name=this.env.contactgroups[b].name=a.name,a.source==this.env.source&&a.id==this.env.group&&this.set_group_prop(a);this.treelist.update(b,c,!0),this.destroy_entity_selector("addressbook-selector"),this.destroy_entity_selector("contactgroup-selector"),this.triggerEvent("group_update",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b),newid:a.newid})},this.update_group_commands=function(){var a=""!=this.env.source?this.env.address_sources[this.env.source]:null,b=a&&a.groups&&!a.readonly;this.enable_command("group-create",b),this.enable_command("group-rename","group-delete",b&&this.env.group)},this.init_edit_field=function(a,b){var c=this.env.coltypes[a].label;b||(b=$(".ff_"+a)),c&&!$('label[for="ff_'+a+'"]').length&&b.placeholder(c)},this.insert_edit_field=function(a,b,c){var d=$("#ff_"+a);if(d.length)$('label[for="ff_'+a+'"]').parent().show(),d.show().focus(),$(c).children('option[value="'+a+'"]').prop("disabled",!0);else{var e=($(".ff_"+a),$("#contactsection"+b+" .contactcontroller"+a));if(!e.length){var f=$("#contactsection"+b),g=$(".contactfieldgroup",f).last();e=$("<fieldset>").addClass("contactfieldgroup contactcontroller"+a),g.length?e.insertAfter(g):f.prepend(e)}if("FIELDSET"==e.get(0).nodeName){var h,i,j=this.env.coltypes[a],k=1!=j.limit?"[]":"",l=!!$(c).data("compact"),m="ff_"+a+(j.count||0),n=$("<div>").addClass("row input-group"),o=$("<div>").addClass("contactfieldcontent "+j.type);if(j.subtypes_select?(h=$(j.subtypes_select),l?h.addClass("input-group-prepend"):h=$("<div>").addClass("contactfieldlabel label").append(h)):(h=$("<label>").addClass("contactfieldlabel label input-group-text").attr("for",m).text(j.label),l&&(h=$('<span class="input-group-prepend">').append(h))),"text"==j.type||"date"==j.type)i=$("<input>").addClass("form-control ff_"+a).attr({type:"text",name:"_"+a+k,size:j.size,id:m}),this.init_edit_field(a,i),"date"==j.type&&$.datepicker&&i.addClass("datepicker").datepicker();else if("textarea"==j.type)i=$("<textarea>").addClass("form-control ff_"+a).attr({name:"_"+a+k,cols:j.size,rows:j.rows,id:m}),this.init_edit_field(a,i);else if("composite"==j.type){var p,q,r,s,t,u=[],v=[],w=o;if(n.addClass("composite"),l&&(w=$('<div class="content input-group-text">')),t=this.env[a+"_template"])for(p=0;p<t.length;p++)u.push(t[p][1]),v.push(t[p][2]);else for(q in j.childs)u.push(q);for(p=0;p<u.length;p++)q=u[p],r=j.childs[q],i=$("<input>").addClass("form-control ff_"+q).attr({type:"text",name:"_"+q+k,size:r.size}).appendTo(w),l||w.append(v[p]||" "),this.init_edit_field(q,i),s||(s=i);i=l?w:s}else if("select"==j.type){i=$("<select>").addClass("custom-select ff_"+a).attr({name:"_"+a+k,id:m});var x=i.attr("options");x[x.length]=new Option("---",""),j.options&&$.each(j.options,function(a,b){x[x.length]=new Option(b,a)})}if(i){var y=$('<a href="#del"></a>').addClass("contactfieldbutton deletebutton input-group-text icon delete").attr({title:this.get_label("delete"),rel:a}).html(this.env.delbutton).click(function(){return ref.delete_edit_field(this),!1});n.append(h),l?(n.append(i).append(y),y.wrap('<span class="input-group-append">')):("composite"!=j.type&&o.append(i),n.append(o.append(y))),n.appendTo(e.show()),i.is("div")?i.find("input").first().focus():i.first().focus(),j.count||(j.count=0),++j.count==j.limit&&j.limit&&$(c).children('option[value="'+a+'"]').prop("disabled",!0),this.triggerEvent("insert-edit-field",i)}}}},this.delete_edit_field=function(a){var b=$(a).attr("rel"),c=this.env.coltypes[b],d=$(a).parents("div.row"),e=$(a).parents("fieldset.contactfieldgroup"),f=e.parent().find("select.addfieldmenu");if(--c.count<=0&&c.visible?d.find("input").val("").blur():(d.remove(),e.children("div.row").length||e.hide()),f.length){var g=f.children('option[value="'+b+'"]');g.length?g.prop("disabled",!1):g=$("<option>").attr("value",b).html(c.label).appendTo(f),f.show()}},this.upload_contact_photo=function(a){a&&a.elements._photo.value&&(this.async_upload_form(a,"upload-photo",function(a){ref.set_busy(!1,null,ref.file_upload_id)}),this.file_upload_id=this.set_busy(!0,"uploading"))},this.replace_contact_photo=function(a){var b="-del-"==a?this.env.photo_placeholder:this.env.comm_path+"&_action=photo&_source="+this.env.source+"&_cid="+(this.env.cid||0)+"&_photo="+a;this.set_photo_actions(a),$(this.gui_objects.contactphoto).children("img").attr("src",b)},this.photo_upload_end=function(){this.set_busy(!1,null,this.file_upload_id),delete this.file_upload_id},this.set_photo_actions=function(a){var b,c=this.buttons["upload-photo"];for(b=0;c&&b<c.length;b++)$("a#"+c[b].id).html(this.get_label("-del-"==a?"addphoto":"replacephoto"));$("#ff_photo").val(a),this.enable_command("upload-photo",!!this.env.coltypes.photo),this.enable_command("delete-photo",this.env.coltypes.photo&&"-del-"!=a)},this.advanced_search=function(){var a=$("<iframe>").attr("src",this.url("search",{_form:1,_framed:1})),b=function(){var b=!1,c={_adv:1};if($.each($(a[0].contentWindow.rcmail.gui_objects.editform).serializeArray(),function(){this.name.match(/^_search/)&&""!=this.value&&(c[this.name]=this.value,b=!0)}),b)return ref.http_post("search",c,ref.set_busy(!0,"searching")),!0};return this.simple_dialog(a,"advsearch",b,{button:"search",width:600,height:500}),!0},this.unselect_directory=function(){this.select_folder(""),this.enable_command("search-delete",!1)},this.insert_saved_search=function(a,b){var c="S"+b,d=$("<a>").attr({href:"#",rel:b}).click(function(){return ref.command("listsearch",b,this)}).html(a),e={name:a,id:b};this.savedsearchlist.insert({id:c,html:d,classes:["contactsearch"]},null,"contactsearch"),this.select_folder(c,"",!0),this.enable_command("search-delete",!0),this.env.search_id=b,this.triggerEvent("abook_search_insert",e)},this.search_create=function(){var a=$("<input>").attr("type","text"),b=$("<label>").text(this.get_label("namex")).append(a);this.simple_dialog(b,"searchsave",function(){var b;if(b=a.val())return ref.http_post("search-create",{_search:ref.env.search_request,_name:b},ref.set_busy(!0,"loading")),!0})},this.search_delete=function(){if(this.env.search_request){var a=this.set_busy(!0,"savedsearchdeleting");this.http_post("search-delete",{_sid:this.env.search_id},a)}},this.remove_search_item=function(a){this.savedsearchlist.remove("S"+a)&&this.triggerEvent("search_delete",{id:a}),this.env.search_id=null,this.env.search_request=null,this.list_contacts_clear(),this.reset_qsearch(),this.enable_command("search-delete","search-create",!1)},this.listsearch=function(a){var b=this.set_busy(!0,"searching");this.contact_list&&this.list_contacts_clear(),this.reset_qsearch(),this.savedsearchlist?(this.treelist.select(""),this.savedsearchlist.select("S"+a)):this.select_folder("S"+a,"",!0),this.env.current_page=1,this.http_request("search",{_sid:a},b)},this.qrcode=function(){var a=new Image(300,300);return a.src=this.url("addressbook/qrcode",{_source:this.env.source,_cid:this.get_single_cid()}),this.simple_dialog(a,"qrcode",null,{button:!1,cancel_button:"close",width:300,height:300})},this.section_select=function(a){var b,c=a.get_single_selection();c&&(b=this.get_frame_window(this.env.contentframe))&&this.location_href({_action:"edit-prefs",_section:c,_framed:1},b,!0)},this.response_select=function(a){var b=a.get_single_selection();this.enable_command("delete",!!b&&$.inArray(b,this.env.readonly_responses)<0),b&&this.load_response(b,"edit-response")},this.load_response=function(a,b){var c;(c=this.get_frame_window(this.env.contentframe))&&(a||"add-response"==b)&&(a||this.responses_list.clear_selection(),this.location_href({_action:b,_id:a,_framed:1},c,!0))},this.identity_select=function(a){var b=a.get_single_selection();this.enable_command("delete",!!b&&a.rowcount>1&&this.env.identities_level<2),b&&this.load_identity(b,"edit-identity")},this.load_identity=function(a,b){var c;(c=this.get_frame_window(this.env.contentframe))&&(a||"add-identity"==b)&&(a||this.identity_list.clear_selection(),this.location_href({_action:b,_iid:a,_framed:1},c,!0))},this.delete_identity=function(a){!a&&this.identity_list&&(a=this.identity_list.get_single_selection()),a&&this.confirm_dialog(this.get_label("deleteidentityconfirm"),"delete",function(){ref.http_post("settings/delete-identity",{_iid:a},!0)})},this.delete_response=function(a){!a&&this.responses_list&&(a=this.responses_list.get_single_selection()),a&&this.confirm_dialog(this.get_label("deleteresponseconfirm"),"delete",function(){ref.http_post("settings/delete-response",{_id:a},!0)})},this.update_identity_row=function(a,b,c){var d=this.identity_list,e=this.html_identifier(a);c?(d.insert_row({id:"rcmrow"+e,cols:[{className:"mail",innerHTML:b}]}),d.select(e)):d.update_row(e,[b])},this.update_response_row=function(a,b,c){var d=this.responses_list;c?(d.insert_row({id:"rcmrow"+a,cols:[{className:"name",innerHTML:b}]}),d.select(a)):d.update_row(a,[b])},this.remove_response=function(a){this.responses_list&&(this.responses_list.remove_row(a),this.show_contentframe(!1)),this.enable_command("delete",!1)},this.remove_identity=function(a){var b=this.identity_list,c=this.html_identifier(a);b&&a&&(b.remove_row(c),this.show_contentframe(!1)),this.enable_command("delete",!1)},this.init_subscription_list=function(){var a=RegExp.escape(this.env.delimiter);this.last_sub_rx=RegExp("["+a+"]?[^"+a+"]+$"),this.subscription_list=new rcube_treelist_widget(this.gui_objects.subscriptionlist,{selectable:!0,tabexit:!1,parent_focus:!0,id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,searchbox:"#foldersearch"}),this.subscription_list.addEventListener("select",function(a){ref.subscription_select(a.id)}).addEventListener("collapse",function(a){ref.folder_collapsed(a)}).addEventListener("expand",function(a){ref.folder_collapsed(a)}).addEventListener("search",function(a){a.query&&ref.subscription_select()}).draggable({cancel:"li.mailbox.root,input,div.treetoggle,.custom-control"}).droppable({accept:function(a){if(!a.is(".mailbox"))return!1;var b=ref.folder_id2name(a.attr("id")),c=ref.folder_id2name(this.id),d=ref.env.subscriptionrows[b];ref.env.subscriptionrows[c];return d&&!d[2]&&c!=b.replace(ref.last_sub_rx,"")&&!c.startsWith(b+ref.env.delimiter)},drop:function(a,b){var c=ref.folder_id2name(b.draggable.attr("id")),d=ref.folder_id2name(this.id);ref.subscription_move_folder(c,d)}})},this.folder_id2name=function(a){return a?ref.html_identifier_decode(a.replace(/^rcmli/,"")):null},this.subscription_select=function(a){var b;a&&"*"!=a&&(b=this.env.subscriptionrows[a])?(this.env.mailbox=a,this.show_folder(a),this.enable_command("delete-folder",!b[2])):(this.env.mailbox=null,this.show_contentframe(!1),this.enable_command("delete-folder","purge",!1))},this.subscription_move_folder=function(a,b){if(a&&null!==b&&a!=b&&b!=a.replace(this.last_sub_rx,"")){var c=a.split(this.env.delimiter),d=c.pop(),e=""===b||"*"===b?d:b+this.env.delimiter+d;e!=a&&this.confirm_dialog(this.get_label("movefolderconfirm"),"move",function(){ref.http_post("rename-folder",{_folder_oldname:a,_folder_newname:e},ref.set_busy(!0,"foldermoving"))},{button_class:"save move"})}},this.create_folder=function(){this.show_folder("",this.env.mailbox)},this.delete_folder=function(a){a||(a=this.env.mailbox),a&&this.confirm_dialog(this.get_label("deletefolderconfirm"),"delete",function(){ref.http_post("delete-folder",{_mbox:a},ref.set_busy(!0,"folderdeleting"))})},this.add_folder_row=function(a,b,c,d,e,f,g,h){if(!this.gui_objects.subscriptionlist)return!1;this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search()),this.subscription_list.is_draggable()&&this.subscription_list.draggable("destroy").droppable("destroy");var i,j,k,l,m,n,o,p,q="",r=[],s=[],t=[],u=$(this.gui_objects.subscriptionlist);if(i=g||$($("li",u).get(1)).clone(!0),!i.length)return this.goto_url("folders"),!1;i.attr({id:"rcmli"+this.html_identifier_encode(a),class:f}),g&&g.length||($("ul,div.treetoggle",i).remove(),i.removeData("filtered")),$("a",i).first().text(c).removeAttr("title"),$('input[name="_subscribed[]"]',i).first().val(a).prop({checked:!!e,disabled:!!d}),this.env.subscriptionrows[a]=[b,c,!1],$.each(this.env.subscriptionrows,function(a,b){b[3]=a,r.push(b)});try{n=new Intl.Collator(this.env.locale.replace("_","-"))}catch(a){}r.sort(function(a,b){var c,d,e,f=a[0].split(ref.env.delimiter),g=b[0].split(ref.env.delimiter),h=f.length;for(c=0;c<h;c++){if(d=f[c],e=g[c],d!==e)return void 0===e?1:n?n.compare(d,e):d<e?-1:1;if(c==h-1)return-1}});for(j in r)if(p=r[j][3],r[j][2]){if((l=p+this.env.delimiter)==this.env.prefix_ns)continue;t.push(p),k=l}else k&&p.startsWith(k)?t.push(p):(s.push(p),k=null);for(j=0;j<t.length;j++)a.startsWith(t[j]+this.env.delimiter)&&(m=t[j]);for(j=0;!m&&j<s.length;j++)j&&s[j]==a&&(m=s[j-1]);if(m&&(j=this.subscription_list.get_item(m,!0)))if((o=a.lastIndexOf(this.env.delimiter))&&(q=a.substring(0,o),q=this.subscription_list.get_item(q,!0),$("div.treetoggle",q).length||$("<div>&nbsp;</div>").addClass("treetoggle collapsed").appendTo(q),$("ul",q).length||$("<ul>").css("display","none").appendTo(q)),q&&j==q)$("ul",q).first().append(i);else{for(;(p=$(j).parent().parent().get(0))&&(!q||p!=q)&&$(p).is("li.mailbox");)j=p;$(j).after(i)}else u.append(i);return $.extend(this.env.subscriptionrows,h||{}),this.subscription_list.reset(!0),this.subscription_select(),q&&this.subscription_list.expand(this.folder_id2name(q.id)),i=i.show().get(0),i.scrollIntoView&&i.scrollIntoView(!1),g||this.triggerEvent("clonerow",{row:i,id:a}),i},this.replace_folder_row=function(a,b,c,d,e,f){if(!this.gui_objects.subscriptionlist)return!!this.is_framed()&&window.parent.rcmail.replace_folder_row(a,b,c,d,e,f);this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var g={},h=this.subscription_list.get_item(a,!0),i=$(h).parent(),j=this.env.subscriptionrows[a],k=a.length,l=j[0].length,m=$('input[name="_subscribed[]"]',h).first().prop("checked");if(a==b)return void $(h).attr("class",f||"");$("li",h).each(function(){var a=ref.folder_id2name(this.id),d=ref.env.subscriptionrows[a],e=b+a.slice(k);this.id="rcmli"+ref.html_identifier_encode(e),$('input[name="_subscribed[]"]',this).first().val(e),d[0]=c+d[0].slice(l),g[e]=d,delete ref.env.subscriptionrows[a]}),h=$(h).detach(),delete this.env.subscriptionrows[a],i.get(0)==this.gui_objects.subscriptionlist||$("li",i).length||$("ul,div.treetoggle",i.parent()).remove(),this.add_folder_row(b,c,d,e,m,f,h,g)},this.remove_folder_row=function(a){this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var b=[],c=this.subscription_list.get_item(a,!0);$("li",c).each(function(){b.push(ref.folder_id2name(this.id))}),this.subscription_list.remove(a),b.push(a),$.each(b,function(a,b){delete ref.env.subscriptionrows[b]})},this.subscribe=function(a){this.change_subscription_state(a,!0)},this.unsubscribe=function(a){this.change_subscription_state(a,!1)},this.change_subscription_state=function(a,b){if(a){var c=b?"":"un",d=this.display_message("folder"+c+"subscribing","loading");this.http_post(c+"subscribe",{_mbox:a},d),$(this.gui_objects.subscriptionlist).find('input[value="'+a+'"]').prop("checked",b)}},this.show_folder=function(a,b,c){var d,e=window,f=""===a?"add":"edit",g="&_action="+f+"-folder&_mbox="+urlencode(a);b&&(g+="&_path="+urlencode(b)),(d=this.get_frame_window(this.env.contentframe))&&(e=d,g+="&_framed=1"),String(e.location.href).indexOf(g)>=0&&!c?this.show_contentframe(!0):this.location_href(this.env.comm_path+g,e,!0)},this.disable_subscription=function(a){var b=this.subscription_list.get_item(a,!0);b&&$('input[name="_subscribed[]"]',b).first().prop("disabled",!0)},this.reset_subscription=function(a,b){var c=this.subscription_list.get_item(a,!0);c&&$('input[name="_subscribed[]"]',c).first().prop("checked",b)},this.folder_size=function(a){var b=this.set_busy(!0,"loading");this.http_post("folder-size",{_mbox:a},b)},this.folder_size_update=function(a){$("#folder-size").replaceWith(a)},this.folder_filter=function(a){this.subscription_list.reset_search(),this.subscription_list.container.children("li").each(function(){var b,c=ref.folder_id2name(this.id);if("---"==a);else if(a){if(c!==a)return void $(this).data("filtered",!0).hide()}else for(b in ref.env.ns_roots)if(c===ref.env.ns_roots[b])return void $(this).data("filtered",!0).hide();$(this).removeData("filtered").show()})},this.init_button=function(a,b){var c=document.getElementById(b.id);if(c){var d=!1;"image"==b.type&&(c=c.parentNode,d=!0),c._command=a,c._id=b.id,b.sel&&(c.onmousedown=function(a){return ref.button_sel(this._command,this._id)},c.onmouseup=function(a){return ref.button_out(this._command,this._id)},d&&((new Image).src=b.sel)),b.over&&(c.onmouseover=function(a){return ref.button_over(this._command,this._id)},c.onmouseout=function(a){return ref.button_out(this._command,this._id)},d&&((new Image).src=b.over))}},this.init_buttons=function(){for(var a in this.buttons)if("string"==typeof a)for(var b=0;b<this.buttons[a].length;b++)this.init_button(a,this.buttons[a][b])},this.set_button=function(a,b){var c,d,e,f=this.buttons[a],g=f?f.length:0;for(c=0;c<g;c++)d=f[c],(e=document.getElementById(d.id))&&d.status!==b&&("image"!=d.type||d.status?d.status||(d.pas=String(e.className)):(d.pas=e._original_src?e._original_src:e.src,e.runtimeStyle&&e.runtimeStyle.filter&&e.runtimeStyle.filter.match(/src=['"]([^'"]+)['"]/)&&(d.pas=RegExp.$1)),d.status=b,"image"==d.type&&d[b]?e.src=d[b]:void 0!==d[b]&&(e.className=d[b]),"input"==d.type||"button"==d.type?e.disabled="pas"==b:$(e).attr({tabindex:"pas"==b||"sel"==b?"-1":$(e).attr("data-tabindex")||"0","aria-disabled":"pas"==b||"sel"==b?"true":"false"}))},this.set_alttext=function(a,b){var c,d,e,f,b,g=this.buttons[a],h=g?g.length:0;for(c=0;c<h;c++)d=g[c],e=document.getElementById(d.id),b=this.get_label(b),e&&"image"==d.type?(e.setAttribute("alt",b),(f=e.parentNode)&&"a"==f.tagName.toLowerCase()&&f.setAttribute("title",b)):e&&e.setAttribute("title",b)},this.button_over=function(a,b){this.button_event(a,b,"over")},this.button_sel=function(a,b){this.button_event(a,b,"sel")},this.button_out=function(a,b){this.button_event(a,b,"act")},this.button_event=function(a,b,c){var d,e,f,g=this.buttons[a],h=g?g.length:0;for(d=0;d<h;d++)e=g[d],e.id==b&&"act"==e.status&&(e[c]&&(f=document.getElementById(e.id))&&(f["image"==e.type?"src":"className"]=e[c]),"sel"==c&&(this.buttons_sel[b]=a))},this.set_pagetitle=function(a){a&&document.title&&(document.title=a)},this.display_message=function(a,b,c,d){if(a&&a.length&&/^[a-z._]+$/.test(a)&&(a=this.get_label(a)),this.is_framed())return parent.rcmail.display_message(a,b,c);if(!this.gui_objects.message)return"loading"!=b&&(this.pending_message=[a,b,c,d]),1;b?"loading"==b&&(d||(d="loading"),c||(c=1e3*this.env.request_timeout),a||(a=this.get_label("loading"))):b="notice",d||(d=this.html_identifier(a));var e=new Date,f=b+e.getTime();if(!c)switch(b){case"error":case"warning":c=2*this.message_time;break;case"uploading":c=0;break;default:c=this.message_time}if(this.messages[d])return this.messages[d].obj&&$("div.content",this.messages[d].obj).html(a),"loading"==b&&this.messages[d].labels.push({id:f,msg:a}),this.messages[d].elements.push(f),setTimeout(function(){ref.hide_message(f,"loading"==b)},c),f;var g=$("<div>").addClass(b+" content").html(a).data("key",d);$(this.gui_objects.message).append(g).show();return this.messages[d]={obj:g,elements:[f]},"loading"==b?this.messages[d].labels=[{id:f,msg:a}]:"uploading"!=b&&g.click(function(){return ref.hide_message(g)}).attr("role","alert"),this.triggerEvent("message",{message:a,type:b,timeout:c,object:g}),c>0&&setTimeout(function(){ref.hide_message(f,"loading"!=b)},c),f},this.hide_message=function(a,b){if(this.is_framed())return parent.rcmail.hide_message(a,b);if(this.gui_objects.message){var c,d,e,f,g=this.messages;if("object"==typeof a)f=$(a),c=f.data("key"),this.hide_message_object(f,b),g[c]&&delete g[c];else for(c in g)for(d in g[c].elements)if(g[c]&&g[c].elements[d]==a)if(g[c].elements.splice(d,1),g[c].elements.length){if("loading"==c)for(e in g[c].labels)g[c].labels[e].id==a?delete g[c].labels[e]:(f=g[c].labels[e].msg,$("div.content",g[c].obj).html(f))}else this.hide_message_object(g[c].obj,b),delete g[c]}},this.hide_message_object=function(a,b){b?a.fadeOut(600,function(){$(this).remove()}):a.hide().remove()},this.clear_messages=function(){if(this.is_framed())return parent.rcmail.clear_messages();var a,b,c=this.messages;for(a in c)for(b in c[a].elements)c[a].obj&&this.hide_message_object(c[a].obj);this.messages={}},this.display_progress=function(a){if(a&&a.name){var b=this.messages["progress"+a.name];if(a.label||(a.label=this.get_label("uploadingmany")),!b)return void((!a.percent||a.percent<100)&&this.display_message(a.label,"uploading",0,"progress"+a.name));if(!a.total||a.percent>=100)return void this.hide_message(b.obj);a.text&&(a.label+=" "+a.text),b.obj.text(a.label)}},this.show_popup_dialog=function(a,b,c,d){if(this.is_framed())return parent.rcmail.show_popup_dialog(a,b,c,d);var e=$('<div class="popup">');"object"==typeof a?(e.append(a),$(a).is("iframe")&&e.addClass("iframe")):e.html(a);var f=0,g=function(a,b,d){return"function"==typeof a?a={click:a,text:d,class:b}:c.class=b,a};d&&d.button_classes&&$.each(c,function(a,b){var e=d.button_classes[f];e&&(c[a]=g(b,e,a)),f++}),d=$.extend({title:b,buttons:c,modal:!0,resizable:!0,width:500,close:function(a,b){$(this).remove()}},d||{}),e.dialog(d),e[0].jqref=$,d.width&&e.width(d.width),d.height&&e.height(d.height);var h=e.parent();if(d.noresize)e.css("width","auto");else{var i=$(window),j=i.width(),k=i.height(),l=e.width(),m=d.height||e[0].scrollHeight+20,n=$(".ui-dialog-titlebar",h).outerHeight()||0,o=$(".ui-dialog-buttonpane",h).outerHeight()||0,p=2*(parseInt(h.css("padding-top"))+parseInt(e.css("padding-top")));e.dialog("option",{height:Math.min(k-40,m+n+o+p+2),width:Math.min(j-20,l+28)})}return h.on("keydown keyup",function(a){a.stopPropagation()}),h.find("input[data-submit]").on("keydown",function(a){13==a.which&&h.find(".ui-dialog-buttonpane button.mainaction").click()}),this.triggerEvent("dialog-open",{obj:e}),e},this.simple_dialog=function(a,b,c,d){d||(d={});var b=this.get_label(b),e=d.button||"save",f=d.button_class||e.replace(/^[^\.]+\./i,""),g=d.cancel_button||"cancel",h=d.cancel_class||g.replace(/^[^\.]+\./i,""),i=function(a,b,c){c||(c=this),c.jqref(c).dialog("close"),d.cancel_func&&d.cancel_func(a,ref)},j=[{text:this.get_label(g),class:h.replace(/close/i,"cancel"),click:i}];return c?j.unshift({text:this.get_label(e),class:"mainaction "+f,click:function(a,b){c(a,ref)&&i(a,b,this)}}):j[0].class+=" mainaction",this.show_popup_dialog(a,b,j,d)},this.alert_dialog=function(a,b,c){return c=$.extend(c||{},{cancel_button:"ok",cancel_class:"save",cancel_func:b,noresize:!0}),this.simple_dialog(a,c.title||"alerttitle",null,c)},this.confirm_dialog=function(a,b,c,d){var e=function(a,b){return c(a,b),!0};return d=$.extend(d||{},{button:b||"continue",noresize:!0}),this.simple_dialog(a,d.title||"confirmationtitle",e,d)},this.set_page_buttons=function(){this.enable_command("nextpage","lastpage",this.env.pagecount>this.env.current_page),this.enable_command("previouspage","firstpage",this.env.current_page>1),this.update_pagejumper()},this.select_folder=function(a,b,c){this.savedsearchlist&&this.savedsearchlist.select(""),this.treelist?this.treelist.select(a):this.gui_objects.folderlist&&($("li.selected",this.gui_objects.folderlist).removeClass("selected"),$(this.get_folder_li(a,b,c)).addClass("selected"),this.triggerEvent("selectfolder",{folder:a,prefix:b}))},this.mark_folder=function(a,b,c,d){$(this.get_folder_li(a,c,d)).addClass(b),this.triggerEvent("markfolder",{folder:a,mark:b,status:!0})},this.unmark_folder=function(a,b,c,d){$(this.get_folder_li(a,c,d)).removeClass(b),this.triggerEvent("markfolder",{folder:a,mark:b,status:!1})},this.get_folder_li=function(a,b,c){if(b||(b="rcmli"),this.gui_objects.folderlist)return a=this.html_identifier(a,c),document.getElementById(b+a)},this.set_message_coltypes=function(a,b,c){this.env.listcols=a,this.msglist_setup(this.env.layout);var b,d,e,f,g,h,i,j=this.message_list,k=j?j.thead:null,l=this.env.msglist_cols;if(this.env.coltypes||(this.env.coltypes={}),k){if(b){k.innerHTML="",i=document.createElement("tr");for(g in l)f=l[g],d=document.createElement("th"),d.innerHTML=b[f].html||"",b[f].id&&(d.id=b[f].id),b[f].className&&(d.className=b[f].className),i.appendChild(d);j.checkbox_selection&&j.insert_checkbox(i,"thead"),k.appendChild(i)}for(g=0,h=l.length;g<h;g++)e=l[j.checkbox_selection?g-1:g],!(d=k.rows[0].cells[g])||"from"!=e&&"to"!=e&&"fromto"!=e||$(d).attr("rel",e).find("span,a").text(this.get_label("fromto"==e?c:e))}this.env.subject_col=null,this.env.flagged_col=null,this.env.status_col=null,this.env.coltypes.folder&&(this.env.coltypes.folder.hidden=!(this.env.search_request||this.env.search_id)||"base"==this.env.search_scope),(g=$.inArray("subject",l))>=0&&(this.env.subject_col=g,j&&(j.subject_col=g)),(g=$.inArray("flag",l))>=0&&(this.env.flagged_col=g),(g=$.inArray("status",l))>=0&&(this.env.status_col=g),j&&(j.hide_column("folder",this.env.coltypes.folder&&this.env.coltypes.folder.hidden||$.inArray("folder",l)<0),j.init_header())},this.set_rowcount=function(a,b){if(b&&b!=this.env.mailbox)return!1;$(this.gui_objects.countdisplay).html(a),this.set_page_buttons()},this.set_mailboxname=function(a){this.gui_objects.mailboxname&&a&&(this.gui_objects.mailboxname.innerHTML=a)},this.set_quota=function(a){this.gui_objects.quotadisplay&&a&&"text"==a.type&&$(this.gui_objects.quotadisplay).text((a.percent||0)+"%").attr("title",a.title||""),this.triggerEvent("setquota",a),this.env.quota_content=a},this.set_trash_count=function(a){this[(a?"un":"")+"mark_folder"](this.env.trash_mailbox,"empty","",!0)},this.set_unread_count=function(a,b,c,d){if(!this.gui_objects.mailboxlist)return!1;this.env.unread_counts[a]=b,this.set_unread_count_display(a,c),d?this.mark_folder(a,d,"",!0):b||this.unmark_folder(a,"recent","",!0),this.mark_all_read_state()},this.set_unread_count_display=function(a,b){var c,d,e,f,g,h,i;if(f=this.get_folder_li(a,"",!0)){if(g=this.env.unread_counts[a]?this.env.unread_counts[a]:0,d=$(f).children("a").eq(0),e=d.children("span.unreadcount"),!e.length&&g&&(e=$("<span>").addClass("unreadcount skip-content").appendTo(d)),c=/\s+\([0-9]+\)$/i,h=0,(i=f.getElementsByTagName("div")[0])&&i.className.match(/collapsed/))for(var j in this.env.unread_counts)j.startsWith(a+this.env.delimiter)&&(h+=this.env.unread_counts[j]);g&&e.length?e.html(this.env.unreadwrap.replace(/%[sd]/,g)):e.length&&e.remove(),c=new RegExp(RegExp.escape(this.env.delimiter)+"[^"+RegExp.escape(this.env.delimiter)+"]+$"),a.match(c)&&this.set_unread_count_display(a.replace(c,""),!1),g+h>0?$(f).addClass("unread"):$(f).removeClass("unread")}if(c=/^\([0-9]+\)\s+/i,b&&document.title){var k="",l=String(document.title);k=g&&l.match(c)?l.replace(c,"("+g+") "):g?"("+g+") "+l:l.replace(c,""),this.set_pagetitle(k)}},this.set_headers=function(a){this.gui_objects.all_headers_box&&a&&$(this.gui_objects.all_headers_box).html(a).show()},this.show_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&this.env.uid&&($(b).removeClass("show-headers").addClass("hide-headers"),$(this.gui_objects.all_headers_row).show(),b.onclick=function(){ref.command("hide-headers","",b)},this.gui_objects.all_headers_box.innerHTML||this.http_request("headers",{_uid:this.env.uid,_mbox:this.env.mailbox},this.display_message("","loading")))},this.hide_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&($(b).removeClass("hide-headers").addClass("show-headers"),$(this.gui_objects.all_headers_row).hide(),b.onclick=function(){ref.command("show-headers","",b)})},this.folder_selector=function(a,b){this.entity_selector("folder-selector",b,this.env.mailboxes_list,function(a,b){var c=0,d=0,e=ref.env.delimiter,f=ref.env.mailboxes[a],g=f.id,h=$("<li>");for(f.virtual?b.addClass("virtual").attr({"aria-disabled":"true",tabindex:"-1"}):b.addClass("active").data("id",f.id),f.class&&h.addClass(f.class);(d=g.indexOf(e,d))>=0;)c++,d++;return b.css("padding-left",c?16*c+"px":0),b.append($("<span>").text(f.name)),h.append(b)},a)},this.addressbook_selector=function(a,b){var c=[];this.entity_selectors["addressbook-selector"]||$.each(this.env.address_sources,function(){if(!this.readonly){var a=this;c.push(a),$.each(ref.env.contactgroups,function(){a.id===this.source&&c.push(this)})}}),this.entity_selector("addressbook-selector",b,c,function(a,b){return"group"==a.type?b.attr("rel",a.source+":"+a.id).addClass("contactgroup active").data({source:a.source,gid:a.id,id:a.source+":"+a.id}).css("padding-left","16px"):b.addClass("addressbook active").data("id",a.id),b.append($("<span>").text(a.name)),$("<li>").append(b)},a)},this.contactgroup_selector=function(a,b){this.entity_selector("contactgroup-selector",b,this.env.contactgroups,function(a,b){if(ref.env.source===a.source)return b.addClass("contactgroup active").data({id:a.id}).append($("<span>").text(a.name)),$("<li>").append(b)},a)},this.entity_selector=function(a,b,c,d,e){var f=this.entity_selectors[a];if(!f){var g=[],f=$("<div>").attr("id",a).addClass("popupmenu"),h=$("<ul>").addClass("toolbarmenu menu"),i=document.createElement("a");i.href="#",i.className="icon",$.each(c,function(a){var b=$(i.cloneNode(!1)).attr("rel",this.id);g.push(d(this,b,a))}),h.append(g).appendTo(f),f.css({left:"-1000px",top:"-1000px"}).appendTo(document.body).show(),g.length>10&&f.css("max-height",10*$("li",f)[0].offsetHeight+9),f.on("click","a.active",function(a){f.data("callback")($(this).data("id"),this)}),this.entity_selectors[a]=f}f.data("callback",b),this.show_menu(a,!0,e)},this.destroy_entity_selector=function(a){$("#"+a).remove(),delete this.entity_selectors[a],this.triggerEvent("destroy-entity-selector",{name:a})},this.show_menu=function(a,b,c){var d="object"==typeof a?a.menu:a,e=$("#"+d),f=c&&c.target?$(c.target):$(e.attr("rel")||"#"+d+"link"),g=rcube_event.is_keyboard(c),h=e.attr("data-align")||"",i=!1;if("A"!=f.get(0).tagName&&f.closest("a").length&&(f=f.closest("a")),"string"==typeof a&&(a={menu:d}),e.length||(e=this.triggerEvent("menu-get",{name:d,props:a,originalEvent:c})),!e||!e.length)return this.triggerEvent(!1===b?"menu-close":"menu-open",{name:d,props:a,originalEvent:c});if(e.appendTo(document.body),void 0===b&&(b=!e.is(":visible")),b&&f.length){var j=$(window),k=f.offset(),l=h.indexOf("bottom")>=0;i="menuitem"==f.attr("role")||f.closest("[role=menuitem]").length>0,f.offsetWidth=f.outerWidth(),f.offsetHeight=f.outerHeight(),!l&&k.top+f.offsetHeight+e.height()>j.height()&&(l=!0),h.indexOf("right")>=0?k.left=k.left+f.outerWidth()-e.width():i&&(k.left=k.left+f.offsetWidth-5,k.top-=f.offsetHeight),k.left+e.width()>j.width()&&(k.left=j.width()-e.width()-12),k.top=Math.max(0,k.top+(l?-e.height():f.offsetHeight)),e.css({left:k.left+"px",top:k.top+"px"})}if(b){for(var m=this.menu_stack.length-1;i&&m>=0;m--)$(f).parents("#"+this.menu_stack[m]).length||"menuitem"==$(c.target).parent().attr("role")||this.hide_menu(this.menu_stack[m],c);i&&this.menu_stack.length?(e.data("parent",$.last(this.menu_stack)),e.css("z-index",($("#"+$.last(this.menu_stack)).css("z-index")||0)+1)):!i&&this.menu_stack.length&&this.hide_menu(this.menu_stack[0],c),e.show().attr("aria-hidden","false").data("opener",f.attr("aria-expanded","true").get(0)),this.triggerEvent("menu-open",{name:d,obj:e,props:a,originalEvent:c}),this.menu_stack.push(d),this.menu_keyboard_active=b&&g,this.menu_keyboard_active&&(this.focused_menu=d,e.find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus())}else this.hide_menu(d,c);return b},this.hide_menu=function(a,b){if(!this.menu_stack.length)return void this.triggerEvent("menu-close",{name:a,props:{menu:a},originalEvent:b});for(var c,d=rcube_event.is_keyboard(b),e=this.menu_stack.length-1;e>=0;e--)c=$("#"+this.menu_stack[e]).hide().attr("aria-hidden","true").data("parent",!1),this.triggerEvent("menu-close",{name:this.menu_stack[e],obj:c,props:{menu:this.menu_stack[e]},originalEvent:b}),this.menu_stack[e]==a&&(e=-1,c.data("opener")&&($(c.data("opener")).attr("aria-expanded","false"),d&&c.data("opener").focus())),this.menu_stack.pop();this.menu_stack.length&&d?(this.menu_keyboard_active=!0,this.focused_menu=$.last(this.menu_stack),c&&c.data("opener")||$("#"+this.focused_menu).find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus()):(this.focused_menu=null,this.menu_keyboard_active=!1)},this.element_position=function(a,b){var b=$(b),c=$(window),d=b.outerWidth(),e=b.outerHeight(),f=b.data("menu-pos"),g=c.height(),h=$(a).height(),i=$(a).width(),j=b.offset(),k=j.top,l=j.left+d;"bottom"==f?(k+=e,l-=d):l-=5,k+h>g&&(k-=h-e)<0&&(k=Math.max(0,(g-h)/2)),l+i>c.width()&&(l-=i+d),a.css({left:l+"px",top:k+"px"})},this.editor_init=function(a,b){this.editor=new rcube_text_editor(a||this.env.editor_config,b)},this.html2plain=function(a,b){return this.format_converter(a,"html",b)},this.plain2html=function(a,b){return this.format_converter(a,"plain",b)},this.format_converter=function(a,b,c){if(!a||"html"==b&&!a.replace(/<[^>]+>|&nbsp;|\xC2\xA0|\s/g,"").length||"html"!=b&&!a.replace(/\xC2\xA0|\s/g,"").length)return c&&setTimeout(function(){c("")},50),!0;var d=this.env.editor_warned||confirm(this.get_label("editorwarning"));if(this.env.editor_warned=!0,!d)return!1;var e="?_task=utils&_action="+("html"==b?"html2text":"text2html"),f=this.set_busy(!0,"converting");return $.ajax({type:"POST",url:e,data:a,contentType:"application/octet-stream",error:function(a,b,c){ref.http_error(a,b,c,f)},success:function(a){ref.set_busy(!1,null,f),c&&c(a)}}),!0},this.url=function(a,b){var c="string"==typeof b?b:"";"string"!=typeof a?b=a:b&&"object"==typeof b||(b={}),a?b._action=a:this.env.action&&(b._action=this.env.action);var d,e=this.env.comm_path,f={};a&&a.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)&&(b._action=RegExp.$2,e=e.replace(/\_task=[a-z0-9_-]+/,"_task="+RegExp.$1)),0===b._framed&&(e=e.replace("&_framed=1",""),b._framed=null);for(d in b)void 0!==b[d]&&null!==b[d]&&(f[d]=b[d]);return(f=$.param(f))&&(e+=(e.indexOf("?")>-1?"&":"?")+f),c&&(e+=(e.indexOf("?")>-1?"&":"?")+c),e},this.redirect=function(a,b){!1!==b&&this.set_busy(!0,"loading"),this.is_framed()?(a=a.replace(/&_framed=1/,""),parent.rcmail.redirect(a,b)):(this.env.extwin&&("string"==typeof a?a+=(a.indexOf("?")<0?"?":"&")+"_extwin=1":a._extwin=1),this.location_href(a,window))},this.goto_url=function(a,b,c,d){var e=this.url(a,b);d&&(e=this.secure_url(e)),this.redirect(e,c)},this.location_href=function(a,b,c){c&&this.lock_frame(b),"object"==typeof a&&(a=this.env.comm_path+"&"+$.param(a)),bw.ie&&b==window?$("<a>").attr("href",a).appendTo(document.body).get(0).click():b.location.href=a,this.start_keepalive()},this.update_state=function(a){if(window.history.replaceState)try{window.history.replaceState({},document.title,rcmail.url("",a))}catch(a){}},this.http_request=function(a,b,c,d){"POST"!=d&&(d="GET"),"object"!=typeof b&&(b=rcube_parse_query(b)),b._remote=1,b._unlock=c||0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;if(e&&e.getResponseHeader)return e;void 0!==e&&(b=e,b._action&&(a=b._action,delete b._action));var f=this.url(a);return this.start_keepalive(),$.ajax({type:d,url:f,data:b,dataType:"json",success:function(a){ref.http_response(a)},error:function(b,d,e){ref.http_error(b,d,e,c,a)}})},this.http_get=this.http_request,this.http_post=function(a,b,c){return this.http_request(a,b,c,"POST")},this.abort_request=function(a){a.request&&a.request.abort(),a.lock&&this.set_busy(!1,null,a.lock)},this.http_response=function(response){if(response){response.unlock&&this.set_busy(!1,null,response.unlock),this.triggerEvent("responsebefore",{response:response}),this.triggerEvent("responsebefore"+response.action,{response:response}),response.env&&this.set_env(response.env);var i;if("object"==typeof response.texts)for(i in response.texts)"string"==typeof response.texts[i]&&this.add_label(i,response.texts[i]);if(response.exec&&eval(response.exec),response.callbacks&&response.callbacks.length)for(i=0;i<response.callbacks.length;i++)this.triggerEvent(response.callbacks[i][0],response.callbacks[i][1]);switch(response.action){case"mark":"show"!=this.env.action&&"preview"!=this.env.action||"SEEN"!=this.env.last_flag||this.set_unread_message(this.env.uid,this.env.mailbox);break;case"delete":if("addressbook"==this.task){var sid,uid=this.contact_list.get_selection(),writable=!1;uid&&this.contact_list.rows[uid]&&(""==this.env.source?(sid=String(uid).replace(/^[^-]+-/,""),writable=sid&&this.env.address_sources[sid]&&!this.env.address_sources[sid].readonly):writable=!this.env.address_sources[this.env.source].readonly),this.enable_command("delete","edit",writable),this.enable_command("export",this.contact_list&&this.contact_list.rowcount>0),this.enable_command("export-selected","print",!1)}case"move":"show"==this.env.action?(this.enable_command(this.env.message_commands,!0),this.env.list_post||this.enable_command("reply-list",!1)):"addressbook"==this.task&&this.triggerEvent("listupdate",{list:this.contact_list,folder:this.env.source,rowcount:this.contact_list.rowcount});case"purge":case"expunge":"mail"==this.task&&(this.env.exists||(this.env.contentframe&&this.show_contentframe(!1),this.enable_command(this.env.message_commands,"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",!1)),this.message_list&&this.triggerEvent("listupdate",{list:this.message_list,folder:this.env.mailbox,rowcount:this.message_list.rowcount}));break;case"refresh":case"check-recent":$.each(this.env.recent_flags||{},function(a,b){ref.set_message(a,"deleted",b.deleted),ref.set_message(a,"replied",b.answered),ref.set_message(a,"unread",!b.seen),ref.set_message(a,"forwarded",b.forwarded),ref.set_message(a,"flagged",b.flagged)}),delete this.env.recent_flags;case"getunread":case"search":this.env.qsearch=null;case"list":if("mail"==this.task){var is_multifolder=this.is_multifolder_listing(),list=this.message_list,uid=this.env.list_uid;this.enable_command("show","select-all","select-none",this.env.messagecount>0),this.enable_command("expunge","purge",this.env.exists&&!is_multifolder),this.enable_command("import-messages",!is_multifolder),this.enable_command("expand-all","expand-unread","collapse-all",this.env.threading&&this.env.messagecount&&!is_multifolder),list&&("list"!=response.action&&"search"!=response.action||(uid&&("FIRST"===uid?uid=list.get_first_row():"LAST"===uid?uid=list.get_last_row():list.rows[uid]||(uid+="-"+this.env.mailbox),uid&&list.rows[uid]&&list.select(uid),delete this.env.list_uid),this.enable_command("set-listmode",this.env.threads&&!is_multifolder),list.rowcount>0&&!$(document.activeElement).is("input,textarea")&&list.focus(),list.triggerEvent("select")),"getunread"!=response.action&&this.triggerEvent("listupdate",{list:list,folder:this.env.mailbox,rowcount:list.rowcount}))}else if("addressbook"==this.task){var list=this.contact_list,uid=this.env.list_uid;this.enable_command("export","select-all","select-none",list&&list.rowcount>0),"list"!=response.action&&"search"!=response.action||(this.enable_command("search-create",""==this.env.source),this.enable_command("search-delete",this.env.search_id),this.update_group_commands(),list&&uid&&("FIRST"===uid?uid=list.get_first_row():"LAST"===uid&&(uid=list.get_last_row()),uid&&list.rows[uid]&&list.select(uid),delete this.env.list_uid,list.triggerEvent("select")),list.rowcount>0&&!$(document.activeElement).is("input,textarea")&&list.focus(),this.triggerEvent("listupdate",{list:list,folder:this.env.source,rowcount:list.rowcount}))}break;case"list-contacts":case"search-contacts":this.contact_list&&(this.contact_list.rowcount>0&&this.contact_list.focus(),this.triggerEvent("listupdate",{list:this.contact_list,rowcount:this.contact_list.rowcount}))}response.unlock&&this.hide_message(response.unlock),this.triggerEvent("responseafter",{response:response}),this.triggerEvent("responseafter"+response.action,{response:response}),this.start_keepalive()}},this.http_error=function(a,b,c,d,e){var f=a.statusText;if(this.set_busy(!1,null,d),a.abort(),!this.unload){a.status&&f?this.display_message(this.get_label("servererror")+" ("+f+")","error"):"timeout"==b?this.display_message("requesttimedout","error"):0==a.status&&"abort"!=b&&this.display_message("connerror","error");var g=a.getResponseHeader("Location");if(g&&"compose"!=this.env.action&&this.redirect(g),403==a.status)return void(this.is_framed()?parent:window).location.reload();"keep-alive"==e&&setTimeout(function(){ref.keep_alive(),ref.start_keepalive()},3e4)}},this.session_error=function(a){this.env.server_error=401,"compose"==this.env.action?(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0,this.env.session_lifetime=0,this._keepalive&&clearInterval(this._keepalive),this._refresh&&clearInterval(this._refresh)):a&&setTimeout(function(){ref.redirect(a,!0)},2e3)},this.iframe_loaded=function(a){a||(a=this.env.frame_lock),this.set_busy(!1,null,a),this.submit_timer&&clearTimeout(this.submit_timer)},this.multi_thread_http_request=function(a){var b,c,d=(new Date).getTime(),e=a.threads||1;for(a.reqid=d,a.running=0,a.requests=[],a.result=[],a._items=$.extend([],a.items),a.lock||(a.lock=this.display_message("","loading")),this.http_request_jobs[d]=a,b=0;b<e&&void 0!==(c=a._items.shift());b++)a.running++,a.requests.push(this.multi_thread_send_request(a,c));return d},this.multi_thread_send_request=function(a,b){var c,d,e;if(a.postdata){d={};for(c in a.postdata)d[c]=String(a.postdata[c]).replace("%s",b);d._reqid=a.reqid}else if("string"==typeof a.query)e=a.query.replace("%s",b),e+="&_reqid="+a.reqid;else if("object"==typeof a.query&&a.query){e={};for(c in a.query)e[c]=String(a.query[c]).replace("%s",b);e._reqid=a.reqid}return d?this.http_post(a.action,d):this.http_request(a.action,e)},this.multi_thread_http_response=function(a,b){var c=this.http_request_jobs[b];if(!(!c||c.running<=0||c.cancelled)){c.running--,c.onresponse&&"function"==typeof c.onresponse&&c.onresponse(a),c.result=$.extend(c.result,a);var d=c._items.shift();void 0!==d?(c.running++,c.requests.push(this.multi_thread_send_request(c,d))):0==c.running&&(c.whendone&&"function"==typeof c.whendone&&c.whendone(c.result),this.set_busy(!1,"",c.lock),delete this.http_request_jobs[b])}},this.multi_thread_request_abort=function(a){var b=this.http_request_jobs[a];if(b){for(var c=0;b.running>0&&c<b.requests.length;c++)b.requests[c].abort&&b.requests[c].abort();b.running=0,b.cancelled=!0,this.set_busy(!1,"",b.lock)}},this.async_upload_form=function(a,b,c){var d=(new Date).getTime(),e="rcmupload"+d;return this.dummy_iframe(e).on("load",{ts:d},c),$(a).attr({target:e,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:d,_from:this.env.action}),method:"POST",enctype:"multipart/form-data"}).submit(),e},this.dummy_iframe=function(a,b){return $("<iframe>").attr({name:a,src:b,style:"width:0;height:0;visibility:hidden","aria-hidden":"true"}).appendTo(document.body)},this.document_drag_hover=function(a,b){$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")},this.file_drag_hover=function(a,b){a.preventDefault(),a.stopPropagation(),$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")},this.file_dropped=function(a){this.file_drag_hover(a,!1);var b,c=a.target.files||a.dataTransfer.files,d={_id:this.env.compose_id||this.env.cid||"",_remote:1,_from:this.env.action};if(c&&c.length)this.file_upload(c,d,{name:(this.env.filedrop.fieldname||"_file")+(this.env.filedrop.single?"":"[]"),single:this.env.filedrop.single,filter:this.env.filedrop.filter,action:ref.env.filedrop.action});else if(b=a.dataTransfer.getData("roundcube-uri")){var e="upload"+(new Date).getTime(),f=$("<span>").text(a.dataTransfer.getData("roundcube-name")||this.get_label("attaching")).html();d._uri=b,d._uploadid=e,this.add2attachment_list(e,{name:"",html:f,classname:"uploading",complete:!1})||(this.file_upload_id=this.set_busy(!0,"attaching")),this.http_post(this.env.filedrop.action||"upload",d)}},this.file_upload=function(a,b,c){if(!window.FormData||!a||!a.length)return!1;var d,e,f,g=0,h=0,i=new FormData,j=c.name||"_file[]",k=c.single?1:a.length;for(args=$.extend({_remote:1,_from:this.env.action},b||{}),e=0;h<k&&(d=a[e]);e++)c.filter&&!d.type.match(new RegExp(c.filter))||(i.append(j,d),g+=d.size,f=d.name,h++);if(h){if(this.env.max_filesize&&this.env.filesizeerror&&g>this.env.max_filesize)return this.display_message(this.env.filesizeerror,"error"),!1;if(this.env.max_filecount&&this.env.filecounterror&&h>this.env.max_filecount)return this.display_message(this.env.filecounterror,"error"),!1;var l="upload"+(new Date).getTime(),m=h>1?this.get_label("uploadingmany"):f,n=$("<span>").text(m).html();this.add2attachment_list(l,{name:"",html:n,classname:"uploading",complete:!1})||c.lock||(c.lock=this.file_upload_id=this.set_busy(!0,"uploading")),args._uploadid=l,args._unlock=c.lock,this.uploads[l]=$.ajax({type:"POST",dataType:"json",url:this.url(c.action||"upload",args),contentType:!1,processData:!1,timeout:this.uploadTimeout,data:i,headers:{"X-Roundcube-Request":this.env.request_token},xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&ref.labels.uploadprogress&&(a.upload.onprogress=function(a){var b=ref.file_upload_msg(a.loaded,a.total);b&&$("#"+l).find(".uploading").text(b)}),a},success:function(a){delete ref.uploads[l],ref.http_response(a)},error:function(a,b,d){delete ref.uploads[l],ref.remove_from_attachment_list(l),ref.http_error(a,b,d,c.lock,"attachment")}})}return!0},this.file_upload_msg=function(a,b){if(b&&a<b){var c=Math.round(a/b*100),d=ref.get_label("uploadprogress");return b>=1073741824?(b=parseFloat(b/1073741824).toFixed(1)+" ".this.get_label("GB"),a=parseFloat(a/1073741824).toFixed(1)):b>=1048576?(b=parseFloat(b/1048576).toFixed(1)+" "+this.get_label("MB"),a=parseFloat(a/1048576).toFixed(1)):b>=1024?(b=parseInt(b/1024)+" "+this.get_label("KB"),a=parseInt(a/1024)):b=b+" "+this.get_label("B"),d.replace("$percent",c+"%").replace("$current",a).replace("$total",b)}},this.start_keepalive=function(){if(this.env.session_lifetime&&!this.env.framed&&!this.env.extwin&&"login"!=this.task&&"print"!=this.env.action){this._keepalive&&clearInterval(this._keepalive);var a=.5*Math.min(1800,this.env.session_lifetime)*1e3;this._keepalive=setInterval(function(){ref.keep_alive()},a<3e4?3e4:a)}},this.start_refresh=function(){!this.env.refresh_interval||this.env.framed||this.env.extwin||"login"==this.task||"print"==this.env.action||(this._refresh&&clearInterval(this._refresh),this._refresh=setInterval(function(){ref.refresh()},1e3*this.env.refresh_interval))},this.keep_alive=function(){this.busy||this.http_request("keep-alive")},this.refresh=function(){if(this.busy)return void setTimeout(function(){ref.refresh(),ref.start_refresh()},1e4);var a={},b=this.set_busy(!0,"refreshing");"mail"==this.task&&this.gui_objects.mailboxlist&&(a=this.check_recent_params()),a._last=Math.floor(this.env.lastrefresh.getTime()/1e3),this.env.lastrefresh=new Date,this.http_post("refresh",a,b)},this.check_recent_params=function(){var a={_mbox:this.env.mailbox};return this.gui_objects.mailboxlist&&(a._folderlist=1),this.gui_objects.quotadisplay&&(a._quota=1),this.env.search_request&&(a._search=this.env.search_request),this.gui_objects.messagelist&&(a._list=1,a._uids=$.map(this.message_list.rows,function(a,b){return b}).join(",")),a},this.quote_html=function(a){return String(a).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},this.opener=function(a,b){var c,d=window.opener;try{if(d&&!d.closed&&d!==window){if(a&&(!d.rcmail||d.rcmail.env.framed)&&d.parent&&d.parent.rcmail&&(d=d.parent),d.rcmail&&b)for(c in b)if(d.rcmail.env[c]!=b[c])return;return d.rcmail}}catch(a){}},this.get_single_uid=function(){var a=this.env.uid||(this.message_list?this.message_list.get_single_selection():null);return ref.triggerEvent("get_single_uid",{uid:a})||a},this.get_single_cid=function(){var a=this.env.cid||(this.contact_list?this.contact_list.get_single_selection():null);return ref.triggerEvent("get_single_cid",{cid:a})||a},this.get_message_mailbox=function(a){var b;return this.env.messages&&a&&(b=this.env.messages[a])&&b.mbox?b.mbox:/^[0-9]+-(.*)$/.test(a)?RegExp.$1:this.env.mailbox},this.params_from_uid=function(a,b){return b||(b={}),b._uid=String(a).split("-")[0],b._mbox=this.get_message_mailbox(a),b},this.get_caret_pos=function(a){return void 0!==a.selectionEnd?a.selectionEnd:a.value.length},this.set_caret_pos=function(a,b){try{a.setSelectionRange&&a.setSelectionRange(b,b)}catch(a){}},this.get_input_selection=function(a){var b=0,c=0,d="";return"number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd&&(d=a.value,b=a.selectionStart,c=a.selectionEnd),{start:b,end:c,text:d.substr(b,c-b)}},this.lock_form=function(a,b){a&&a.elements&&(b&&(this.disabled_form_elements=[]),$.each(a.elements,function(){"hidden"!=this.type&&(b&&this.disabled?ref.disabled_form_elements.push(this):(b||$.inArray(this,ref.disabled_form_elements)<0)&&(this.disabled=b))}))},this.mailto_handler_uri=function(){return location.href.split("?")[0]+"?_task=mail&_action=compose&_to=%s"},this.register_protocol_handler=function(a){try{window.navigator.registerProtocolHandler("mailto",this.mailto_handler_uri(),a)}catch(a){this.display_message(String(a),"error")}},this.check_protocol_handler=function(a,b){var c=window.navigator;if(c&&"function"==typeof c.registerProtocolHandler)if("function"==typeof c.isProtocolHandlerRegistered){var d=c.isProtocolHandlerRegistered("mailto",this.mailto_handler_uri());d&&$(b).parent().find(".mailtoprotohandler-status").html(d)}else $(b).click(function(){return ref.register_protocol_handler(a),!1});else $(b).addClass("disabled").click(function(){return ref.display_message("nosupporterror","error"),!1})},this.browser_capabilities_check=function(){this.env.browser_capabilities||(this.env.browser_capabilities={}),$.each(["pdf","flash","tiff","webp","pgpmime"],function(){void 0===ref.env.browser_capabilities[this]&&(ref.env.browser_capabilities[this]=ref[this+"_support_check"]())})},this.browser_capabilities=function(){if(!this.env.browser_capabilities)return"";var a,b=[];for(a in this.env.browser_capabilities)b.push(a+"="+this.env.browser_capabilities[a]);return b.join()},this.tiff_support_check=function(){return this.image_support_check("tiff"),0},this.webp_support_check=function(){return this.image_support_check("webp"),0},this.image_support_check=function(a){setTimeout(function(){var b=new Image;b.onload=function(){ref.env.browser_capabilities[a]=1},b.onerror=function(){ref.env.browser_capabilities[a]=0},b.src=ref.assets_path("program/resources/blank."+a)},10)},this.pdf_support_check=function(){if("pdfViewerEnabled"in navigator)return navigator.pdfViewerEnabled?1:0;var a,b=navigator.mimeTypes?navigator.mimeTypes["application/pdf"]:{},c=/Adobe Reader|PDF|Acrobat/i;if(b&&b.enabledPlugin)return 1;for(a in navigator.plugins)if("string"==typeof(b=navigator.plugins[a])){if(c.test(b))return 1}else if(b.name&&c.test(b.name))return 1;return setTimeout(function(){$("<object>").attr({data:ref.assets_path("program/resources/dummy.pdf"),type:"application/pdf",style:'position: "absolute"; top: -1000px; height: 1px; width: 1px'}).on("load error",function(a){ref.env.browser_capabilities.pdf="load"==a.type?1:0;var b=this;setTimeout(function(){$(b).remove()},10)}).appendTo(document.body)},10),0},this.flash_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/x-shockwave-flash"]:{};if(a&&a.enabledPlugin)return 1;if("ActiveXObject"in window)try{if(a=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))return 1}catch(a){}return 0},this.pgpmime_support_check=function(a){return window.mailvelope?1:($(window).on("mailvelope",function(){ref.env.browser_capabilities.pgpmime=1}),0)},this.assets_path=function(a){return this.env.assets_path&&!a.startsWith(this.env.assets_path)&&(a=this.env.assets_path+a),a},this.set_cookie=function(a,b,c){if(!1===c){var c=new Date;c.setYear(c.getFullYear()+1)}setCookie(a,b,c,this.env.cookie_path,this.env.cookie_domain,this.env.cookie_secure)},this.get_local_storage_prefix=function(){return this.local_storage_prefix||(this.local_storage_prefix="roundcube."+(this.env.user_id||"anonymous")+"."),this.local_storage_prefix},this.local_storage_get_item=function(a,b,c){var d,e;try{d=localStorage.getItem(this.get_local_storage_prefix()+a),e=JSON.parse(d)}catch(a){}return e||b||null},this.local_storage_set_item=function(a,b,c){try{return localStorage.setItem(this.get_local_storage_prefix()+a,JSON.stringify(b)),!0}catch(a){return!1}},this.local_storage_remove_item=function(a){try{return localStorage.removeItem(this.get_local_storage_prefix()+a),!0}catch(a){return!1}},this.print_dialog=function(){setTimeout("window.print()",10)}}rcube_webmail.long_subject_title=function(a,b,c){if(!a.title){var d=0,e=$(c||a);e.siblings().each(function(){d+=$(this).width()+(parseFloat(window.getComputedStyle(this,":before").width)||0)}),e.width()+d+15*(b||0)>=e.parent().width()-3&&(a.title=rcube_webmail.subject_text(e[0]))}},rcube_webmail.long_subject_title_ex=function(a){if(!a.title){var b=$(a),c=b.text().trim(),d=$("span.branch",b).width()||0,e=$("<span>").text(c).css({position:"absolute",float:"left",visibility:"hidden","font-size":b.css("font-size"),"font-weight":b.css("font-weight")}).appendTo(document.body),f=e.width();e.remove(),f+15*d>b.width()&&(a.title=rcube_webmail.subject_text(a))}},rcube_webmail.subject_text=function(a){var b=$(a).clone();return b.find(".skip-on-drag,.skip-content,.voice").remove(),b.text().trim()},rcube_webmail.set_iframe_events=function(a){$("iframe").each(function(){var b=$(this);$.each(a,function(a,c){b.on("load",function(b){try{$(this).contents().on(a,c)}catch(b){}});try{b.contents().on(a,c)}catch(a){}})})},rcube_webmail.prototype.get_cookie=getCookie,rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener,rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener,rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;